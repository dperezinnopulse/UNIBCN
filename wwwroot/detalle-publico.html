<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Actividad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- WebLot para traducci√≥n autom√°tica -->
    <script type="text/javascript" src="https://cdn.weglot.com/weglot.min.js?v=1.0"></script>
    <script>
        // Funci√≥n para inicializar WebLot con reintentos
        function inicializarWebLot() {
            console.log('üåê Intentando inicializar WebLot...');
            
            if (typeof Weglot !== 'undefined') {
                try {
                    Weglot.initialize({
                        api_key: 'wg_b2253dca073d4e70fd4476374ae59e149',
                        original_language: 'es',
                        destination_languages: ['en', 'fr', 'ca'],
                        switchers: [{
                            button_style: {
                                full_name: true,
                                with_name: true,
                                is_dropdown: true,
                                with_flags: true
                            },
                            target: '#weglot-container'
                        }]
                    });
                    console.log('‚úÖ WebLot inicializado correctamente');
                    return true;
                } catch (error) {
                    console.error('‚ùå Error inicializando WebLot:', error);
                    return false;
                }
            } else {
                console.log('‚è≥ WebLot a√∫n no est√° disponible, reintentando...');
                return false;
            }
        }

        // Intentar inicializar inmediatamente
        if (!inicializarWebLot()) {
            // Si falla, esperar a que el DOM est√© listo
            document.addEventListener('DOMContentLoaded', function() {
                if (!inicializarWebLot()) {
                    // Si a√∫n falla, reintentar cada 500ms hasta 10 segundos
                    let intentos = 0;
                    const maxIntentos = 20; // 10 segundos
                    const intervalo = setInterval(() => {
                        intentos++;
                        if (inicializarWebLot()) {
                            clearInterval(intervalo);
                        } else if (intentos >= maxIntentos) {
                            console.error('‚ùå WebLot no se pudo inicializar despu√©s de 10 segundos');
                            clearInterval(intervalo);
                        }
                    }, 500);
                }
            });
        }
    </script>
    <style>
        body { background-color: #f8f9fa; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #fff; padding: 1.5rem 0; }
        .container-narrow { max-width: 1000px; margin: 0 auto; }
        .card-section { background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); padding: 1.5rem; margin-top: 1rem; }
        .meta { color: #6c757d; }
        .tag { background: #e3f2fd; color: #1e3c72; padding: 0.25rem 0.6rem; border-radius: 12px; font-size: .85rem; margin-right: .4rem; margin-bottom: .4rem; display: inline-block; }
        .tag.gratuito { background: #e8f5e8; color: #2e7d32; }
        .field-group { border-left: 3px solid #e3f2fd; padding-left: 1rem; margin-bottom: 1rem; }
        .empty-field { color: #999; font-style: italic; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container-narrow d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <a href="web-publica.html" class="text-white text-decoration-none"><i class="fas fa-home me-2"></i>Oferta formativa</a>
                <a href="manual-alumnos/consultar-detalles.html" class="text-white text-decoration-none" title="Ayuda sobre esta p√°gina">
                    <i class="fas fa-question-circle fs-5"></i>
                </a>
                <!-- Contenedor para WebLot -->
                <div id="weglot-container"></div>
            </div>
            <img src="img/logo_ub.png" alt="UB" style="height:48px">
        </div>
    </div>

    <div class="container-narrow">
        <div id="loading" class="text-center py-5 text-muted">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="mt-3">Cargando actividad...</div>
        </div>
        <div id="error" class="alert alert-danger d-none mt-3"></div>

        <div id="detalle" class="d-none">
            <!-- Cabecera principal -->
            <div class="card-section">
                <div class="row">
                    <div class="col-lg-8">
                        <h1 id="titulo" class="mb-2 text-primary"></h1>
                        <p id="codigo" class="text-muted mb-2"></p>
                        <p id="descripcion" class="lead mb-3"></p>
                    </div>
                    <div class="col-lg-4 text-end">
                        <div id="logoUnidadGestion" class="mb-3"></div>
                        <div id="estadoBadge" class="mb-2"></div>
                        <div id="unidadGestion" class="text-muted"></div>
                        <div id="anioAcademico" class="text-muted"></div>
                        <!-- Bot√≥n de preinscripci√≥n -->
                        <div id="preinscripcionSection" class="mt-3">
                            <button id="btnPreinscribirse" class="btn btn-success btn-lg" style="display: none;">
                                <i class="fas fa-user-plus me-2"></i>Inscribirme
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n b√°sica -->
            <div class="card-section">
                <h5 class="mb-3"><i class="fas fa-info-circle text-primary me-2"></i>Informaci√≥n b√°sica</h5>
                <div class="row g-3">
                    <div class="col-md-4" id="metaTipoActividad"></div>
                    <div class="col-md-4" id="metaModalidadGestion"></div>
                    <div class="col-md-4" id="metaCodigoRelacionado"></div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6" id="metaCondicionesEconomicas"></div>
                    <div class="col-md-6" id="metaMotivoCierre"></div>
                </div>
            </div>

            <!-- Fechas y temporalizaci√≥n -->
            <div class="card-section">
                <h5 class="mb-3"><i class="fas fa-calendar-alt text-primary me-2"></i>Fechas y temporalizaci√≥n</h5>
                <div class="row g-3">
                    <div class="col-md-4" id="metaFechaInicio"></div>
                    <div class="col-md-4" id="metaFechaFin"></div>
                    <div class="col-md-4" id="metaFechaActividad"></div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-4" id="metaFechaInicioImparticion"></div>
                    <div class="col-md-4" id="metaFechaFinImparticion"></div>
                    <div class="col-md-4" id="metaLugar"></div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-4" id="metaProgramaInicio"></div>
                    <div class="col-md-4" id="metaProgramaFin"></div>
                    <div class="col-md-4" id="metaProgramaDuracion"></div>
                </div>
            </div>

            <!-- Plazas y duraci√≥n -->
            <div class="card-section">
                <h5 class="mb-3"><i class="fas fa-users text-primary me-2"></i>Plazas y duraci√≥n</h5>
                <div class="row g-3">
                    <div class="col-md-4" id="metaPlazasTotales"></div>
                    <div class="col-md-4" id="metaHorasTotales"></div>
                    <div class="col-md-4" id="metaCentroTrabajoRequerido"></div>
                </div>
            </div>

            <!-- Cr√©ditos acad√©micos -->
            <div class="card-section" id="creditosSection">
                <h5 class="mb-3"><i class="fas fa-certificate text-primary me-2"></i>Cr√©ditos acad√©micos</h5>
                <div class="row g-3">
                    <div class="col-md-6" id="metaCreditosTotalesCRAI"></div>
                    <div class="col-md-6" id="metaCreditosTotalesSAE"></div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6" id="metaCreditosMinimosSAE"></div>
                    <div class="col-md-6" id="metaCreditosMaximosSAE"></div>
                </div>
            </div>

            <!-- L√≠neas estrat√©gicas -->
            <div class="card-section" id="estrategicaSection">
                <h5 class="mb-3"><i class="fas fa-bullseye text-primary me-2"></i>L√≠neas estrat√©gicas</h5>
                <div class="row g-3">
                    <div class="col-md-6" id="metaLineaEstrategica"></div>
                    <div class="col-md-6" id="metaObjetivoEstrategico"></div>
                </div>
            </div>

            <!-- Responsables -->
            <div class="card-section">
                <h5 class="mb-3"><i class="fas fa-user-tie text-primary me-2"></i>Responsables</h5>
                <div class="row g-3">
                    <div class="col-md-6" id="metaPersonaSolicitante"></div>
                    <div class="col-md-6" id="metaCoordinador"></div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6" id="metaJefeUnidadGestora"></div>
                    <div class="col-md-6" id="metaGestorActividad"></div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6" id="metaCoordinadorCentreUnitat"></div>
                    <div class="col-md-6" id="metaCentreTreballeAlumne"></div>
                </div>
            </div>

            <!-- Destinatarios -->
            <div class="card-section" id="destinatariosSection">
                <h5 class="mb-3"><i class="fas fa-building text-primary me-2"></i>Destinatarios</h5>
                <div class="row g-3">
                    <div class="col-md-6" id="metaFacultadDestinataria"></div>
                    <div class="col-md-6" id="metaDepartamentoDestinatario"></div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6" id="metaCentroUnidadUBDestinataria"></div>
                    <div class="col-md-6" id="metaOtrosCentrosInstituciones"></div>
                </div>
            </div>

            <!-- Inscripci√≥n -->
            <div class="card-section" id="inscripcionSection">
                <h5 class="mb-3"><i class="fas fa-user-plus text-primary me-2"></i>Inscripci√≥n</h5>
                <div class="row g-3">
                    <div class="col-md-4" id="metaInscripcionInicio"></div>
                    <div class="col-md-4" id="metaInscripcionFin"></div>
                    <div class="col-md-4" id="metaInscripcionPlazas"></div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6" id="metaInscripcionModalidad"></div>
                    <div class="col-md-6" id="metaInscripcionListaEspera"></div>
                </div>
                
                <!-- Requisitos multiidioma -->
                <div class="mt-3" id="requisitosSection">
                    <h6 class="text-muted mb-2">Requisitos de inscripci√≥n:</h6>
                    <div class="field-group" id="metaInscripcionRequisitosES"></div>
                    <div class="field-group" id="metaInscripcionRequisitosCA"></div>
                    <div class="field-group" id="metaInscripcionRequisitosEN"></div>
                </div>
            </div>

            <!-- Programa detallado -->
            <div class="card-section" id="programaSection">
                <h5 class="mb-3"><i class="fas fa-book text-primary me-2"></i>Programa detallado</h5>
                
                <!-- Descripci√≥n multiidioma -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Descripci√≥n del programa:</h6>
                    <div class="field-group" id="metaProgramaDescripcionES"></div>
                    <div class="field-group" id="metaProgramaDescripcionCA"></div>
                    <div class="field-group" id="metaProgramaDescripcionEN"></div>
                </div>
                
                <!-- Contenidos multiidioma -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Contenidos:</h6>
                    <div class="field-group" id="metaProgramaContenidosES"></div>
                    <div class="field-group" id="metaProgramaContenidosCA"></div>
                    <div class="field-group" id="metaProgramaContenidosEN"></div>
                </div>
                
                <!-- Objetivos multiidioma -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Objetivos:</h6>
                    <div class="field-group" id="metaProgramaObjetivosES"></div>
                    <div class="field-group" id="metaProgramaObjetivosCA"></div>
                    <div class="field-group" id="metaProgramaObjetivosEN"></div>
                </div>
            </div>

            <!-- Campos espec√≠ficos SAE -->
            <div class="card-section" id="saeSection">
                <h5 class="mb-3"><i class="fas fa-star text-primary me-2"></i>Informaci√≥n espec√≠fica SAE</h5>
                <div class="row g-3">
                    <div class="col-md-4" id="metaTipusEstudiSAE"></div>
                    <div class="col-md-4" id="metaCategoriaSAE"></div>
                    <div class="col-md-4" id="metaCompetenciesSAE"></div>
                </div>
            </div>

            <!-- Precios e importes -->
            <div class="card-section" id="preciosSection">
                <h5 class="mb-3"><i class="fas fa-euro-sign text-primary me-2"></i>Precios e importes</h5>
                <div class="row g-3">
                    <div class="col-md-6" id="metaActividadPago"></div>
                    <div class="col-md-6" id="metaImporteBase"></div>
                </div>
                <div id="importesDescuentosDetalle" class="mt-3"></div>
            </div>

            <!-- Caracter√≠sticas y opciones -->
            <div class="card-section">
                <h5 class="mb-3"><i class="fas fa-tags text-primary me-2"></i>Caracter√≠sticas</h5>
                <div class="d-flex flex-wrap gap-2">
                    <span id="tagActividadReservada" class="tag d-none"><i class="fas fa-lock me-1"></i>Actividad reservada</span>
                    <span id="tagActividadPago" class="tag d-none"><i class="fas fa-credit-card me-1"></i>Actividad de pago</span>
                    <span id="tagCentroTrabajoRequerido" class="tag d-none"><i class="fas fa-building me-1"></i>Centro de trabajo requerido</span>
                    <span id="tagInscripcionListaEspera" class="tag d-none"><i class="fas fa-list me-1"></i>Lista de espera disponible</span>
                </div>
            </div>

            <!-- Informaci√≥n del sistema -->
            <div class="card-section">
                <h5 class="mb-3"><i class="fas fa-clock text-primary me-2"></i>Informaci√≥n del sistema</h5>
                <div class="row g-3 text-muted small">
                    <div class="col-md-6" id="metaFechaCreacion"></div>
                    <div class="col-md-6" id="metaFechaModificacion"></div>
                </div>
                <div class="row g-3 mt-2 text-muted small">
                    <div class="col-md-6" id="metaUsuarioAutor"></div>
                    <div class="col-md-6" id="metaEstadoId"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Preinscripci√≥n -->
    <div class="modal fade" id="modalPreinscripcion" tabindex="-1" aria-labelledby="modalPreinscripcionLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalPreinscripcionLabel">
                        <i class="fas fa-user-plus me-2"></i>Preinscripci√≥n en Actividad
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formPreinscripcion">
                        <div class="row g-3">
                            <!-- Tipo de Documento -->
                            <div class="col-md-6">
                                <label for="tipoDocumento" class="form-label">Tipo de Documento <span class="text-danger">*</span></label>
                                <select class="form-select" id="tipoDocumento" name="tipoDocumento" required>
                                    <option value="">Seleccione...</option>
                                    <option value="NIF">NIF</option>
                                    <option value="NIE">NIE</option>
                                    <option value="PASAPORTE">PASAPORTE</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- N√∫mero de Documento -->
                            <div class="col-md-6">
                                <label for="numeroDocumento" class="form-label">N√∫mero de Documento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="numeroDocumento" name="numeroDocumento" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Nombre -->
                            <div class="col-md-6">
                                <label for="nombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="nombre" name="nombre" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Apellido 1 -->
                            <div class="col-md-6">
                                <label for="apellido1" class="form-label">Primer Apellido <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="apellido1" name="apellido1" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Apellido 2 -->
                            <div class="col-md-6">
                                <label for="apellido2" class="form-label">Segundo Apellido <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="apellido2" name="apellido2" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Tel√©fono -->
                            <div class="col-md-6">
                                <label for="telefono" class="form-label">Tel√©fono <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="telefono" name="telefono" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Email -->
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" name="email" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Confirmar Email -->
                            <div class="col-md-6">
                                <label for="confirmarEmail" class="form-label">Confirmar Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="confirmarEmail" name="confirmarEmail" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n de la actividad -->
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="text-muted mb-2">Actividad seleccionada:</h6>
                            <div id="infoActividadPreinscripcion" class="text-primary"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="btnGuardarPreinscripcion">
                        <i class="fas fa-save me-2"></i>Guardar Preinscripci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n para mostrar resultados de preinscripci√≥n -->
    <div id="resultadoPreinscripcion" class="d-none mt-4">
        <!-- Aqu√≠ se mostrar√°n los resultados de la preinscripci√≥n -->
    </div>

    <script>
    function qs(name){ const p = new URLSearchParams(location.search); return p.get(name); }
    function fmtDate(d){ if(!d) return ''; const x=new Date(d); return x.toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'}); }

    async function cargarDetalle(){
        const id = qs('id');
        if(!id){ 
            document.getElementById('loading').classList.add('d-none'); 
            const e=document.getElementById('error'); 
            e.textContent='ID de actividad no especificado'; 
            e.classList.remove('d-none'); 
            return; 
        }
        
        try{
            // Cargar actividad usando el endpoint p√∫blico espec√≠fico
            let act;
            
            // Cargar actividad desde endpoint p√∫blico espec√≠fico
            console.log('üåê Cargando actividad desde endpoint p√∫blico espec√≠fico...');
            const resp = await fetch(`http://localhost:5001/api/actividades/publicas/${id}`);
            if(!resp.ok){ 
                if(resp.status === 404) {
                    throw new Error('Actividad no encontrada o no est√° publicada');
                }
                throw new Error('HTTP '+resp.status); 
            }
            act = await resp.json();
            console.log('‚úÖ Datos cargados desde endpoint p√∫blico espec√≠fico');
            
            if(!act){ throw new Error('Actividad no encontrada'); }
            
            console.log('Datos completos de la actividad:', act);
            console.log('Campos espec√≠ficos:');
            console.log('- tipoActividad:', act.tipoActividad);
            console.log('- plazasTotales:', act.plazasTotales);
            console.log('- horasTotales:', act.horasTotales);
            console.log('- lineaEstrategica:', act.lineaEstrategica);
            console.log('- personaSolicitante:', act.personaSolicitante);
            
            // Funci√≥n helper para mostrar campo
            const mostrarCampo = (elementId, label, valor, icono = '', esTextoLargo = false) => {
                const el = document.getElementById(elementId);
                if(el) {
                    if(valor !== null && valor !== undefined && valor !== '' && valor !== 0) {
                        if(esTextoLargo) {
                            el.innerHTML = `<strong>${icono}${label}:</strong><div class="mt-2">${valor}</div>`;
                        } else {
                            el.innerHTML = `<strong>${icono}${label}:</strong><br>${valor}`;
                        }
                        el.style.display = '';
                    } else {
                        el.style.display = 'none';
                    }
                }
            };
            
            // Funci√≥n para mostrar boolean
            const mostrarBoolean = (elementId, label, valor, icono = '') => {
                const el = document.getElementById(elementId);
                if(el) {
                    if(valor === true || valor === false) {
                        const texto = valor === true ? 'S√≠' : 'No';
                        el.innerHTML = `<strong>${icono}${label}:</strong><br>${texto}`;
                        el.style.display = '';
                    } else {
                        el.style.display = 'none';
                    }
                }
            };
            
            // ===== CABECERA PRINCIPAL =====
            document.getElementById('titulo').textContent = act.titulo || 'Sin t√≠tulo';
            document.getElementById('codigo').textContent = act.codigo ? `C√≥digo: ${act.codigo}` : 'Sin c√≥digo';
            document.getElementById('descripcion').textContent = act.descripcion || 'Sin descripci√≥n disponible';
            document.getElementById('anioAcademico').textContent = act.anioAcademico ? `A√±o acad√©mico: ${act.anioAcademico}` : '';
            
            // Estado y unidad gesti√≥n
            if(act.estado?.nombre) {
                const badge = document.getElementById('estadoBadge');
                badge.innerHTML = `<span class="badge bg-primary fs-6">${act.estado.nombre}</span>`;
            }
            
            console.log('üè¢ Debug UG en detalle:', {
                unidadGestion: act.unidadGestion,
                unidadGestionId: act.unidadGestionId
            });
            
            // A√±adir datos de unidad gesti√≥n si no est√°n
            if (!act.unidadGestion && act.unidadGestionId) {
                const ugMapping = {
                    1: { id: 1, nombre: 'Institut de Desenvolupament Professional' },
                    2: { id: 2, nombre: 'Centre de Recursos per a l\'Aprenentatge i la Investigaci√≥' },
                    3: { id: 3, nombre: 'Servei d\'Activitats Extraordin√†ries' }
                };
                act.unidadGestion = ugMapping[act.unidadGestionId] || null;
                console.log('üîß UG a√±adida manualmente:', act.unidadGestion);
            }
            
            if(act.unidadGestion?.nombre) {
                document.getElementById('unidadGestion').innerHTML = `<i class="fas fa-building me-1"></i>${act.unidadGestion.nombre}`;
                
                // Mostrar logo de la unidad gestora
                const logoContainer = document.getElementById('logoUnidadGestion');
                let logoSrc = '';
                const ugNombre = act.unidadGestion.nombre.toLowerCase();
                
                if(ugNombre.includes('crai') || ugNombre.includes('recursos')) {
                    logoSrc = 'img/CRAI.png';
                } else if(ugNombre.includes('idp') || ugNombre.includes('desenvolupament')) {
                    logoSrc = 'img/IDP.jpeg';
                } else if(ugNombre.includes('sae') || ugNombre.includes('extraordin√†ries')) {
                    logoSrc = 'img/SAE.jpeg';
                }
                
                console.log('üñºÔ∏è Logo asignado:', logoSrc);
                
                if(logoSrc) {
                    logoContainer.innerHTML = `<img src="${logoSrc}" alt="${act.unidadGestion.nombre}" style="max-height: 60px; max-width: 150px; object-fit: contain;">`;
                }
            } else {
                console.log('‚ùå No hay datos de unidad gesti√≥n para mostrar logo');
            }
            
            // ===== INFORMACI√ìN B√ÅSICA =====
            mostrarCampo('metaTipoActividad', 'Tipo de actividad', act.tipoActividad, '<i class="fas fa-tag me-1"></i>');
            mostrarCampo('metaModalidadGestion', 'Modalidad de gesti√≥n', act.modalidadGestion, '<i class="fas fa-cogs me-1"></i>');
            mostrarCampo('metaCodigoRelacionado', 'C√≥digo relacionado', act.codigoRelacionado, '<i class="fas fa-link me-1"></i>');
            mostrarCampo('metaCondicionesEconomicas', 'Condiciones econ√≥micas', act.condicionesEconomicas, '<i class="fas fa-euro-sign me-1"></i>');
            mostrarCampo('metaMotivoCierre', 'Motivo de cierre', act.motivoCierre, '<i class="fas fa-times-circle me-1"></i>');
            
            // ===== FECHAS Y TEMPORALIZACI√ìN =====
            mostrarCampo('metaFechaInicio', 'Fecha inicio', act.fechaInicio ? fmtDate(act.fechaInicio) : null, '<i class="fas fa-play me-1"></i>');
            mostrarCampo('metaFechaFin', 'Fecha fin', act.fechaFin ? fmtDate(act.fechaFin) : null, '<i class="fas fa-stop me-1"></i>');
            mostrarCampo('metaFechaActividad', 'Fecha de la actividad', act.fechaActividad ? fmtDate(act.fechaActividad) : null, '<i class="fas fa-calendar-day me-1"></i>');
            mostrarCampo('metaFechaInicioImparticion', 'Inicio impartici√≥n', act.fechaInicioImparticion ? fmtDate(act.fechaInicioImparticion) : null, '<i class="fas fa-chalkboard-teacher me-1"></i>');
            mostrarCampo('metaFechaFinImparticion', 'Fin impartici√≥n', act.fechaFinImparticion ? fmtDate(act.fechaFinImparticion) : null, '<i class="fas fa-chalkboard me-1"></i>');
            mostrarCampo('metaLugar', 'Lugar', act.lugar, '<i class="fas fa-map-marker-alt me-1"></i>');
            mostrarCampo('metaProgramaInicio', 'Programa inicio', act.programaInicio ? fmtDate(act.programaInicio) : null, '<i class="fas fa-play-circle me-1"></i>');
            mostrarCampo('metaProgramaFin', 'Programa fin', act.programaFin ? fmtDate(act.programaFin) : null, '<i class="fas fa-stop-circle me-1"></i>');
            mostrarCampo('metaProgramaDuracion', 'Duraci√≥n del programa', act.programaDuracion ? `${act.programaDuracion} horas` : null, '<i class="fas fa-hourglass-half me-1"></i>');
            
            console.log('Debug fechas:');
            console.log('- fechaActividad:', act.fechaActividad);
            console.log('- fechaInicioImparticion:', act.fechaInicioImparticion);
            console.log('- fechaFinImparticion:', act.fechaFinImparticion);
            
            // ===== PLAZAS Y DURACI√ìN =====
            mostrarCampo('metaPlazasTotales', 'Plazas totales', act.plazasTotales, '<i class="fas fa-users me-1"></i>');
            mostrarCampo('metaHorasTotales', 'Horas totales', act.horasTotales, '<i class="fas fa-clock me-1"></i>');
            mostrarCampo('metaCentroTrabajoRequerido', 'Centro trabajo requerido', act.centroTrabajoRequerido, '<i class="fas fa-briefcase me-1"></i>');
            
            // ===== CR√âDITOS ACAD√âMICOS =====
            mostrarCampo('metaCreditosTotalesCRAI', 'Cr√©ditos totales CRAI', act.creditosTotalesCRAI, '<i class="fas fa-certificate me-1"></i>');
            mostrarCampo('metaCreditosTotalesSAE', 'Cr√©ditos totales SAE', act.creditosTotalesSAE, '<i class="fas fa-certificate me-1"></i>');
            mostrarCampo('metaCreditosMinimosSAE', 'Cr√©ditos m√≠nimos SAE', act.creditosMinimosSAE, '<i class="fas fa-arrow-down me-1"></i>');
            mostrarCampo('metaCreditosMaximosSAE', 'Cr√©ditos m√°ximos SAE', act.creditosMaximosSAE, '<i class="fas fa-arrow-up me-1"></i>');
            
            // ===== L√çNEAS ESTRAT√âGICAS =====
            mostrarCampo('metaLineaEstrategica', 'L√≠nea estrat√©gica', act.lineaEstrategica, '<i class="fas fa-arrow-right me-1"></i>');
            mostrarCampo('metaObjetivoEstrategico', 'Objetivo estrat√©gico', act.objetivoEstrategico, '<i class="fas fa-target me-1"></i>');
            
            // ===== RESPONSABLES =====
            console.log('Debug responsables:');
            console.log('- personaSolicitante:', act.personaSolicitante);
            console.log('- coordinador:', act.coordinador);
            console.log('- jefeUnidadGestora:', act.jefeUnidadGestora);
            console.log('- gestorActividad:', act.gestorActividad);
            
            mostrarCampo('metaPersonaSolicitante', 'Persona solicitante', act.personaSolicitante, '<i class="fas fa-user me-1"></i>');
            mostrarCampo('metaCoordinador', 'Coordinador', act.coordinador, '<i class="fas fa-user-tie me-1"></i>');
            mostrarCampo('metaJefeUnidadGestora', 'Jefe unidad gestora', act.jefeUnidadGestora, '<i class="fas fa-user-cog me-1"></i>');
            mostrarCampo('metaGestorActividad', 'Gestor de actividad', act.gestorActividad, '<i class="fas fa-user-check me-1"></i>');
            mostrarCampo('metaCoordinadorCentreUnitat', 'Coordinador centre/unitat', act.coordinadorCentreUnitat, '<i class="fas fa-user-graduate me-1"></i>');
            mostrarCampo('metaCentreTreballeAlumne', 'Centre treball alumne', act.centreTreballeAlumne, '<i class="fas fa-briefcase me-1"></i>');
            
            // ===== DESTINATARIOS =====
            mostrarCampo('metaFacultadDestinataria', 'Facultad destinataria', act.facultadDestinataria, '<i class="fas fa-university me-1"></i>');
            mostrarCampo('metaDepartamentoDestinatario', 'Departamento destinatario', act.departamentoDestinatario, '<i class="fas fa-building me-1"></i>');
            mostrarCampo('metaCentroUnidadUBDestinataria', 'Centro/Unidad UB destinataria', act.centroUnidadUBDestinataria, '<i class="fas fa-home me-1"></i>');
            mostrarCampo('metaOtrosCentrosInstituciones', 'Otros centros/instituciones', act.otrosCentrosInstituciones, '<i class="fas fa-globe me-1"></i>', true);
            
            // ===== INSCRIPCI√ìN =====
            mostrarCampo('metaInscripcionInicio', 'Inscripci√≥n inicio', act.inscripcionInicio ? fmtDate(act.inscripcionInicio) : null, '<i class="fas fa-calendar-plus me-1"></i>');
            mostrarCampo('metaInscripcionFin', 'Inscripci√≥n fin', act.inscripcionFin ? fmtDate(act.inscripcionFin) : null, '<i class="fas fa-calendar-minus me-1"></i>');
            mostrarCampo('metaInscripcionPlazas', 'Plazas para inscripci√≥n', act.inscripcionPlazas, '<i class="fas fa-users me-1"></i>');
            mostrarCampo('metaInscripcionModalidad', 'Modalidad de inscripci√≥n', act.inscripcionModalidad, '<i class="fas fa-clipboard me-1"></i>');
            mostrarBoolean('metaInscripcionListaEspera', 'Lista de espera', act.inscripcionListaEspera, '<i class="fas fa-list me-1"></i>');
            
            // Requisitos multiidioma
            if(act.inscripcionRequisitosES) {
                document.getElementById('metaInscripcionRequisitosES').innerHTML = `<strong>üá™üá∏ Requisitos (Espa√±ol):</strong><div class="mt-2">${act.inscripcionRequisitosES}</div>`;
            }
            if(act.inscripcionRequisitosCA) {
                document.getElementById('metaInscripcionRequisitosCA').innerHTML = `<strong>üè¥Û†Å•Û†Å≥Û†Å£Û†Å¥Û†Åø Requisits (Catal√†):</strong><div class="mt-2">${act.inscripcionRequisitosCA}</div>`;
            }
            if(act.inscripcionRequisitosEN) {
                document.getElementById('metaInscripcionRequisitosEN').innerHTML = `<strong>üá¨üáß Requirements (English):</strong><div class="mt-2">${act.inscripcionRequisitosEN}</div>`;
            }
            
            // ===== PROGRAMA DETALLADO =====
            // Descripci√≥n multiidioma
            if(act.programaDescripcionES) {
                document.getElementById('metaProgramaDescripcionES').innerHTML = `<strong>üá™üá∏ Descripci√≥n (Espa√±ol):</strong><div class="mt-2">${act.programaDescripcionES}</div>`;
            }
            if(act.programaDescripcionCA) {
                document.getElementById('metaProgramaDescripcionCA').innerHTML = `<strong>üè¥Û†Å•Û†Å≥Û†Å£Û†Å¥Û†Åø Descripci√≥ (Catal√†):</strong><div class="mt-2">${act.programaDescripcionCA}</div>`;
            }
            if(act.programaDescripcionEN) {
                document.getElementById('metaProgramaDescripcionEN').innerHTML = `<strong>üá¨üáß Description (English):</strong><div class="mt-2">${act.programaDescripcionEN}</div>`;
            }
            
            // Contenidos multiidioma
            if(act.programaContenidosES) {
                document.getElementById('metaProgramaContenidosES').innerHTML = `<strong>üá™üá∏ Contenidos (Espa√±ol):</strong><div class="mt-2">${act.programaContenidosES}</div>`;
            }
            if(act.programaContenidosCA) {
                document.getElementById('metaProgramaContenidosCA').innerHTML = `<strong>üè¥Û†Å•Û†Å≥Û†Å£Û†Å¥Û†Åø Continguts (Catal√†):</strong><div class="mt-2">${act.programaContenidosCA}</div>`;
            }
            if(act.programaContenidosEN) {
                document.getElementById('metaProgramaContenidosEN').innerHTML = `<strong>üá¨üáß Contents (English):</strong><div class="mt-2">${act.programaContenidosEN}</div>`;
            }
            
            // Objetivos multiidioma
            if(act.programaObjetivosES) {
                document.getElementById('metaProgramaObjetivosES').innerHTML = `<strong>üá™üá∏ Objetivos (Espa√±ol):</strong><div class="mt-2">${act.programaObjetivosES}</div>`;
            }
            if(act.programaObjetivosCA) {
                document.getElementById('metaProgramaObjetivosCA').innerHTML = `<strong>üè¥Û†Å•Û†Å≥Û†Å£Û†Å¥Û†Åø Objectius (Catal√†):</strong><div class="mt-2">${act.programaObjetivosCA}</div>`;
            }
            if(act.programaObjetivosEN) {
                document.getElementById('metaProgramaObjetivosEN').innerHTML = `<strong>üá¨üáß Objectives (English):</strong><div class="mt-2">${act.programaObjetivosEN}</div>`;
            }
            
            // ===== CAMPOS ESPEC√çFICOS SAE =====
            mostrarCampo('metaTipusEstudiSAE', 'Tipus d\'estudi SAE', act.tipusEstudiSAE, '<i class="fas fa-graduation-cap me-1"></i>');
            mostrarCampo('metaCategoriaSAE', 'Categoria SAE', act.categoriaSAE, '<i class="fas fa-layer-group me-1"></i>');
            mostrarCampo('metaCompetenciesSAE', 'Compet√®ncies SAE', act.competenciesSAE, '<i class="fas fa-star me-1"></i>', true);
            
            // ===== TAGS Y CARACTER√çSTICAS =====
            if(act.actividadReservada === true) { 
                document.getElementById('tagActividadReservada').classList.remove('d-none'); 
            }
            if(act.actividadPago === true) { 
                document.getElementById('tagActividadPago').classList.remove('d-none'); 
            }
            if(act.centroTrabajoRequerido === 'Si' || act.centroTrabajoRequerido === true) { 
                document.getElementById('tagCentroTrabajoRequerido').classList.remove('d-none'); 
            }
            if(act.inscripcionListaEspera === true) { 
                document.getElementById('tagInscripcionListaEspera').classList.remove('d-none'); 
            }
            
            // ===== PRECIOS E IMPORTES =====
            mostrarBoolean('metaActividadPago', 'Es de pago', act.actividadPago, '<i class="fas fa-credit-card me-1"></i>');
            
            // Cargar y mostrar TODOS los ImportesDescuentos
            try {
                const importesResponse = await fetch(`http://localhost:5001/api/actividades/${act.id}/importes`);
                if (importesResponse.ok) {
                    const importesCompletos = await importesResponse.json();
                    console.log('üí∞ ImportesDescuentos cargados:', importesCompletos);
                    
                    if (importesCompletos && importesCompletos.length > 0) {
                        // Mostrar resumen en metaImporteBase
                        const totalImportes = importesCompletos.length;
                        const importeBase = importesCompletos[0].importeBase;
                        if (importeBase) {
                            mostrarCampo('metaImporteBase', 'Importe principal', `${importeBase}‚Ç¨ (${totalImportes} concepto${totalImportes > 1 ? 's' : ''})`, '<i class="fas fa-euro-sign me-1"></i>');
                        }
                        
                        // Mostrar TODOS los importes detallados
                        const importesHtml = importesCompletos.map((imp, index) => `
                            <div class="border rounded p-3 mb-3" style="background: #f8f9fa;">
                                <h6 class="text-primary mb-2">
                                    <i class="fas fa-receipt me-2"></i>Concepto ${index + 1}
                                </h6>
                                <div class="row g-2">
                                    ${imp.importeBase ? `
                                        <div class="col-md-4">
                                            <strong>üí∞ Importe base:</strong><br>
                                            <span class="fs-5 text-success">${imp.importeBase}‚Ç¨</span>
                                        </div>
                                    ` : ''}
                                    ${imp.tipoImpuesto ? `
                                        <div class="col-md-4">
                                            <strong>üìä Tipo impuesto:</strong><br>
                                            ${imp.tipoImpuesto}
                                        </div>
                                    ` : ''}
                                    ${imp.porcentajeDescuento ? `
                                        <div class="col-md-4">
                                            <strong>üè∑Ô∏è Descuento:</strong><br>
                                            <span class="text-danger">${imp.porcentajeDescuento}%</span>
                                        </div>
                                    ` : ''}
                                </div>
                                ${imp.codigoPromocional ? `
                                    <div class="mt-2">
                                        <strong>üé´ C√≥digo promocional:</strong> 
                                        <code>${imp.codigoPromocional}</code>
                                    </div>
                                ` : ''}
                                ${imp.condicionesES ? `
                                    <div class="mt-2">
                                        <strong>üìù Condiciones (ES):</strong><br>
                                        <small class="text-muted">${imp.condicionesES}</small>
                                    </div>
                                ` : ''}
                                ${imp.condicionesCA ? `
                                    <div class="mt-2">
                                        <strong>üìù Condicions (CA):</strong><br>
                                        <small class="text-muted">${imp.condicionesCA}</small>
                                    </div>
                                ` : ''}
                                ${imp.condicionesEN ? `
                                    <div class="mt-2">
                                        <strong>üìù Conditions (EN):</strong><br>
                                        <small class="text-muted">${imp.condicionesEN}</small>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('');
                        
                        document.getElementById('importesDescuentosDetalle').innerHTML = `
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-list me-2"></i>Detalle completo de importes y descuentos:
                            </h6>
                            ${importesHtml}
                        `;
                    } else {
                        document.getElementById('importesDescuentosDetalle').innerHTML = `
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-info-circle me-2"></i>
                                No hay importes configurados para esta actividad
                            </div>
                        `;
                    }
                } else {
                    console.log('‚ùå Error cargando importes');
                }
            } catch (e) {
                console.log('‚ùå Error en petici√≥n de importes:', e);
            }

            // ===== INFORMACI√ìN DEL SISTEMA =====
            document.getElementById('metaFechaCreacion').innerHTML = act.fechaCreacion ? `<strong>Creada:</strong> ${fmtDate(act.fechaCreacion)}` : '';
            document.getElementById('metaFechaModificacion').innerHTML = act.fechaModificacion ? `<strong>√öltima modificaci√≥n:</strong> ${fmtDate(act.fechaModificacion)}` : '';
            document.getElementById('metaUsuarioAutor').innerHTML = act.usuarioAutor?.username ? `<strong>Creado por:</strong> ${act.usuarioAutor.username}` : '';
            document.getElementById('metaEstadoId').innerHTML = `<strong>Estado ID:</strong> ${act.estadoId}`;
            
            // Funci√≥n para ocultar secciones completamente vac√≠as
            const ocultarSeccionSiVacia = (sectionId) => {
                const section = document.getElementById(sectionId);
                if(section) {
                    const visibleElements = section.querySelectorAll('[id^="meta"]:not([style*="display: none"])');
                    if(visibleElements.length === 0) {
                        section.style.display = 'none';
                    }
                }
            };
            
            // Ocultar secciones vac√≠as
            setTimeout(() => {
                ocultarSeccionSiVacia('creditosSection');
                ocultarSeccionSiVacia('estrategicaSection');
                ocultarSeccionSiVacia('destinatariosSection');
                ocultarSeccionSiVacia('inscripcionSection');
                ocultarSeccionSiVacia('programaSection');
                ocultarSeccionSiVacia('saeSection');
            }, 100);
            
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('detalle').classList.remove('d-none');
            
            // Mostrar bot√≥n de preinscripci√≥n si la actividad est√° publicada
            if (act.estado?.nombre?.toLowerCase() === 'publicada') {
                document.getElementById('btnPreinscribirse').style.display = 'block';
            }
            
        }catch(err){
            console.error('Error cargando actividad:', err);
            document.getElementById('loading').classList.add('d-none');
            const e=document.getElementById('error'); 
            e.textContent = 'Error cargando actividad: '+err.message; 
            e.classList.remove('d-none');
        }
    }

    // ===== FUNCIONES DE PREINSCRIPCI√ìN =====
    
    // Validaciones de documentos
    function validarDocumento(tipo, numero) {
        if (!numero) return false;
        
        switch(tipo) {
            case 'NIF':
                // NIF: 8 d√≠gitos + letra
                const nifRegex = /^[0-9]{8}[TRWAGMYFPDXBNJZSQVHLCKE]$/i;
                return nifRegex.test(numero);
            case 'NIE':
                // NIE: X/Y/Z + 7 d√≠gitos + letra
                const nieRegex = /^[XYZ][0-9]{7}[TRWAGMYFPDXBNJZSQVHLCKE]$/i;
                return nieRegex.test(numero);
            case 'PASAPORTE':
                // Pasaporte: alfanum√©rico, m√≠nimo 6 caracteres
                const pasaporteRegex = /^[A-Z0-9]{6,}$/i;
                return pasaporteRegex.test(numero);
            default:
                return false;
        }
    }
    
    // Validar formulario completo
    function validarFormularioPreinscripcion() {
        let esValido = true;
        
        // Limpiar validaciones anteriores
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
        
        const form = document.getElementById('formPreinscripcion');
        const formData = new FormData(form);
        
        // Validar tipo de documento
        const tipoDocumento = formData.get('tipoDocumento');
        if (!tipoDocumento) {
            document.getElementById('tipoDocumento').classList.add('is-invalid');
            document.querySelector('#tipoDocumento + .invalid-feedback').textContent = 'Seleccione un tipo de documento';
            esValido = false;
        }
        
        // Validar n√∫mero de documento
        const numeroDocumento = formData.get('numeroDocumento');
        if (!numeroDocumento) {
            document.getElementById('numeroDocumento').classList.add('is-invalid');
            document.querySelector('#numeroDocumento + .invalid-feedback').textContent = 'El n√∫mero de documento es obligatorio';
            esValido = false;
        } else if (tipoDocumento && !validarDocumento(tipoDocumento, numeroDocumento)) {
            document.getElementById('numeroDocumento').classList.add('is-invalid');
            let mensaje = '';
            switch(tipoDocumento) {
                case 'NIF': mensaje = 'NIF debe tener 8 d√≠gitos seguidos de una letra'; break;
                case 'NIE': mensaje = 'NIE debe empezar por X/Y/Z, seguido de 7 d√≠gitos y una letra'; break;
                case 'PASAPORTE': mensaje = 'Pasaporte debe ser alfanum√©rico (m√≠nimo 6 caracteres)'; break;
            }
            document.querySelector('#numeroDocumento + .invalid-feedback').textContent = mensaje;
            esValido = false;
        }
        
        // Validar campos obligatorios
        const camposObligatorios = ['nombre', 'apellido1', 'apellido2', 'telefono', 'email'];
        camposObligatorios.forEach(campo => {
            const valor = formData.get(campo);
            if (!valor || valor.trim() === '') {
                document.getElementById(campo).classList.add('is-invalid');
                document.querySelector(`#${campo} + .invalid-feedback`).textContent = 'Este campo es obligatorio';
                esValido = false;
            }
        });
        
        // Validar email
        const email = formData.get('email');
        const confirmarEmail = formData.get('confirmarEmail');
        if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
            document.getElementById('email').classList.add('is-invalid');
            document.querySelector('#email + .invalid-feedback').textContent = 'Formato de email inv√°lido';
            esValido = false;
        }
        
        // Validar confirmaci√≥n de email
        if (confirmarEmail && email !== confirmarEmail) {
            document.getElementById('confirmarEmail').classList.add('is-invalid');
            document.querySelector('#confirmarEmail + .invalid-feedback').textContent = 'Los emails no coinciden';
            esValido = false;
        }
        
        return esValido;
    }
    
    // Enviar preinscripci√≥n
    async function enviarPreinscripcion() {
        if (!validarFormularioPreinscripcion()) {
            return;
        }
        
        const form = document.getElementById('formPreinscripcion');
        const formData = new FormData(form);
        const actividadId = qs('id');
        
        const datosPreinscripcion = {
            tipoDocumento: formData.get('tipoDocumento'),
            numeroDocumento: formData.get('numeroDocumento'),
            nombre: formData.get('nombre'),
            apellido1: formData.get('apellido1'),
            apellido2: formData.get('apellido2'),
            email: formData.get('email'),
            telefono: formData.get('telefono'),
            actividadId: parseInt(actividadId)
        };
        
        console.log('üì§ Datos de preinscripci√≥n a enviar:', datosPreinscripcion);
        
        try {
            // Mostrar loading en el bot√≥n
            const btnGuardar = document.getElementById('btnGuardarPreinscripcion');
            const textoOriginal = btnGuardar.innerHTML;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            btnGuardar.disabled = true;
            
            const response = await fetch('http://localhost:5001/api/preinscripciones', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datosPreinscripcion)
            });
            
            const resultado = await response.json();
            
            if (response.ok) {
                // √âxito
                mostrarResultadoPreinscripcion('success', '‚úÖ Preinscripci√≥n enviada correctamente. Recibir√° un email de confirmaci√≥n.');
                // Cerrar modal y limpiar formulario despu√©s de 3 segundos
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalPreinscripcion'));
                    modal.hide();
                    form.reset();
                    ocultarResultadoPreinscripcion();
                }, 3000);
            } else {
                // Error
                const errorMsg = resultado.message || 'Error desconocido';
                mostrarResultadoPreinscripcion('error', `‚ùå Error al enviar la preinscripci√≥n: ${errorMsg}`, resultado);
            }
            
        } catch (error) {
            console.error('Error enviando preinscripci√≥n:', error);
            mostrarResultadoPreinscripcion('error', '‚ùå Error de conexi√≥n. Int√©ntelo de nuevo.', error);
        } finally {
            // Restaurar bot√≥n
            const btnGuardar = document.getElementById('btnGuardarPreinscripcion');
            btnGuardar.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Preinscripci√≥n';
            btnGuardar.disabled = false;
        }
    }
    
    // Funci√≥n para mostrar resultado de preinscripci√≥n
    function mostrarResultadoPreinscripcion(tipo, mensaje, detalles = null) {
        const resultadoDiv = document.getElementById('resultadoPreinscripcion');
        if (!resultadoDiv) {
            console.error('Elemento resultadoPreinscripcion no encontrado');
            return;
        }
        
        const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
        const iconClass = tipo === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
        
        let contenido = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="${iconClass} me-2"></i>
                <strong>${mensaje}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // En modo desarrollo, mostrar detalles del error
        if (tipo === 'error' && detalles) {
            contenido += `
                <div class="mt-3">
                    <h6 class="text-danger">Detalles del error (modo desarrollo):</h6>
                    <pre class="bg-light p-3 rounded small text-muted" style="max-height: 200px; overflow-y: auto;">${JSON.stringify(detalles, null, 2)}</pre>
                </div>
            `;
            
            // Si hay detalles HTTP, mostrarlos de forma m√°s legible
            if (detalles.detallesHttp) {
                const http = detalles.detallesHttp;
                contenido += `
                    <div class="mt-3">
                        <h6 class="text-info">üì° Detalles de la llamada HTTP:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">üì§ Petici√≥n:</h6>
                                <div class="bg-light p-2 rounded small">
                                    <strong>URL:</strong> ${http.Url}<br>
                                    <strong>M√©todo:</strong> ${http.Metodo}<br>
                                    <strong>Content-Type:</strong> ${http.ContentType || 'No especificado'}<br>
                                    <strong>Headers:</strong><br>
                                    <pre class="small text-muted">${JSON.stringify(http.HeadersPeticion, null, 2)}</pre>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-warning">üì• Respuesta:</h6>
                                <div class="bg-light p-2 rounded small">
                                    <strong>Status Code:</strong> <span class="badge bg-danger">${http.StatusCode}</span><br>
                                    <strong>Headers:</strong><br>
                                    <pre class="small text-muted">${JSON.stringify(http.HeadersRespuesta, null, 2)}</pre>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <h6 class="text-success">üìÑ Body de la petici√≥n (XML SOAP):</h6>
                            <pre class="bg-dark text-light p-2 rounded small" style="max-height: 300px; overflow-y: auto;">${http.BodyPeticion}</pre>
                        </div>
                        <div class="mt-2">
                            <h6 class="text-warning">üìÑ Body de la respuesta:</h6>
                            <pre class="bg-warning text-dark p-2 rounded small" style="max-height: 200px; overflow-y: auto;">${http.BodyRespuesta || '(vac√≠o)'}</pre>
                        </div>
                    </div>
                `;
            }
        }
        
        resultadoDiv.innerHTML = contenido;
        resultadoDiv.classList.remove('d-none');
        
        // Scroll hacia el resultado
        resultadoDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Funci√≥n para ocultar resultado de preinscripci√≥n
    function ocultarResultadoPreinscripcion() {
        const resultadoDiv = document.getElementById('resultadoPreinscripcion');
        if (resultadoDiv) {
            resultadoDiv.classList.add('d-none');
            resultadoDiv.innerHTML = '';
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOMContentLoaded - Configurando event listeners...');
        
        // Bot√≥n de preinscripci√≥n
        const btnPreinscribirse = document.getElementById('btnPreinscribirse');
        if (btnPreinscribirse) {
            console.log('‚úÖ Bot√≥n de preinscripci√≥n encontrado, agregando event listener...');
            btnPreinscribirse.addEventListener('click', function() {
                console.log('üñ±Ô∏è Bot√≥n de preinscripci√≥n clickeado!');
                
                try {
                    const modalElement = document.getElementById('modalPreinscripcion');
                    if (!modalElement) {
                        console.error('‚ùå Modal no encontrado');
                        return;
                    }
                    
                    console.log('‚úÖ Modal encontrado, creando instancia Bootstrap...');
                    const modal = new bootstrap.Modal(modalElement);
                    
                    // Cargar informaci√≥n de la actividad en el modal
                    const actividadId = qs('id');
                    const titulo = document.getElementById('titulo').textContent;
                    const codigo = document.getElementById('codigo').textContent;
                    
                    console.log('üìù Cargando informaci√≥n de actividad:', { actividadId, titulo, codigo });
                    
                    const infoElement = document.getElementById('infoActividadPreinscripcion');
                    if (infoElement) {
                        infoElement.innerHTML = `
                            <strong>${titulo}</strong><br>
                            <small class="text-muted">${codigo}</small>
                        `;
                    }
                    
                    console.log('üé≠ Mostrando modal...');
                    
                    // Limpiar resultado anterior
                    ocultarResultadoPreinscripcion();
                    
                    modal.show();
                } catch (error) {
                    console.error('‚ùå Error al mostrar modal:', error);
                    alert('Error al abrir el formulario de preinscripci√≥n: ' + error.message);
                }
            });
        } else {
            console.error('‚ùå Bot√≥n de preinscripci√≥n no encontrado');
        }
        
        // Bot√≥n guardar preinscripci√≥n
        document.getElementById('btnGuardarPreinscripcion').addEventListener('click', enviarPreinscripcion);
        
        // Validaci√≥n en tiempo real del n√∫mero de documento
        document.getElementById('numeroDocumento').addEventListener('input', function() {
            const tipo = document.getElementById('tipoDocumento').value;
            const numero = this.value;
            
            if (tipo && numero) {
                if (validarDocumento(tipo, numero)) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            }
        });
        
        // Validaci√≥n de confirmaci√≥n de email
        document.getElementById('confirmarEmail').addEventListener('input', function() {
            const email = document.getElementById('email').value;
            const confirmarEmail = this.value;
            
            if (email && confirmarEmail) {
                if (email === confirmarEmail) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            }
        });
    });
    
    document.addEventListener('DOMContentLoaded', cargarDetalle);
    </script>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
