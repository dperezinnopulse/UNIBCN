<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  
  <title>Hist√≥rico de Propuestas - UB (v2.1 - $(new Date().getTime()))</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- SheetJS para exportar a Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- Estilos comunes del proyecto (men√∫/header unificados) -->
  <link href="css/styles.css" rel="stylesheet"/>
  <style>
    body { background-color: #f5f7fa; }
    /* Contenedor para diferenciar secciones */
    .section-title {
      margin-bottom: 1rem;
    }
    /* Estilos para la lista de propuestas */
    #proposalList[data-view="list"] .proposal-item {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      /* Borde azulado similar al ejemplo */
      border: 1px solid #d4dffc;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      background-color: #ffffff;
    }
    #proposalList[data-view="list"] .proposal-item .proposal-link {
      text-decoration: none;
      color: inherit;
      flex-grow: 1;
      margin-right: 1rem;
    }
    #proposalList[data-view="list"] .proposal-item.unread {
      background-color: #eef5ff;
    }
    #proposalList[data-view="list"] .proposal-item .proposal-content {
      flex-grow: 1;
    }
    #proposalList[data-view="list"] .proposal-item .proposal-meta {
      /* Meta informaci√≥n distribuida a la derecha, ocupando ~25% del ancho */
      flex: 0 0 25%;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.5rem;
      justify-content: flex-start;
    }
    /* Vista en tarjetas */
    #proposalList[data-view="cards"] {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    #proposalList[data-view="cards"] .proposal-item {
      width: calc(50% - 0.5rem);
      border: 1px solid #d4dffc;
      border-radius: 0.5rem;
      background-color: #ffffff;
      display: flex;
      flex-direction: column;
      text-decoration: none;
      color: inherit;
    }
    #proposalList[data-view="cards"] .proposal-item.unread {
      background-color: #eef5ff;
    }
    /* Ajustamos elementos internos en vista de tarjetas */
    #proposalList[data-view="cards"] .proposal-item .proposal-content {
      padding: 1rem;
      flex-grow: 1;
    }
    #proposalList[data-view="cards"] .proposal-item .proposal-meta {
      /* Meta informaci√≥n ahora est√° dentro de proposal-content */
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #dee2e6;
    }
    /* Botones de conmutaci√≥n de vista */
    .view-toggle .btn {
      margin-left: 0.5rem;
    }
    .view-toggle .btn.active {
      background-color: #e7effb;
      color: #0366d6;
    }
    /* Filtros avanzados */
    .filtros-avanzados {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #dee2e6;
    }
    .filtros-avanzados .row {
      margin-bottom: 0.5rem;
    }
    .filtros-avanzados .col-md-3 {
      margin-bottom: 0.5rem;
    }
    /* Controles de ordenaci√≥n */
    .ordenacion-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .ordenacion-controls select {
      min-width: 200px;
    }
    
    /* Responsive Design - Corregir problema en m√≥viles */
    @media (max-width: 768px) {
      /* En m√≥viles, cambiar layout de lista a vertical */
      #proposalList[data-view="list"] .proposal-item {
        flex-direction: column;
        align-items: stretch;
      }
      
      #proposalList[data-view="list"] .proposal-item .proposal-link {
        margin-right: 0;
        margin-bottom: 0.75rem;
      }
      
      #proposalList[data-view="list"] .proposal-item .proposal-meta {
        /* En m√≥viles, volver a distribuci√≥n horizontal */
        flex: none;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      /* Badges m√°s peque√±os en m√≥vil */
      #proposalList[data-view="list"] .proposal-item .proposal-meta .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
      
      /* Vista de tarjetas en m√≥vil - una por fila */
      #proposalList[data-view="cards"] .proposal-item {
        width: 100%;
      }
      
      /* Filtros m√°s compactos en m√≥vil */
      .filtros-avanzados .col-md-3 {
        margin-bottom: 0.75rem;
      }
      
      .ordenacion-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .ordenacion-controls select {
        min-width: auto;
        width: 100%;
      }
    }
    
    @media (max-width: 576px) {
      /* Extra peque√±o - ajustes adicionales */
      .proposal-item {
        padding: 0.75rem !important;
      }
      
      .proposal-meta .badge {
        font-size: 0.7rem !important;
      }
    }
  </style>
</head>
  <body>
<div class="d-flex">
<!-- Contenedor para el men√∫ lateral cargado din√°micamente -->
<div id="sidebarContainer"></div>
<!-- Contenido principal -->
<div class="flex-grow-1">
<!-- Contenedor de la cabecera (se insertar√° din√°micamente) -->
<div id="headerContainer"></div>
<!-- Contenido -->
<main class="p-4">
        <div class="d-flex align-items-center mb-3 flex-wrap gap-3">
          <h1 class="h4 mb-0 flex-grow-1">Hist√≥rico de Propuestas</h1>
          <!-- Zona de b√∫squeda, filtros y cambio de vista -->
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" id="buscador" placeholder="Buscar por t√≠tulo o c√≥digo" />
            </div>
            <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAvanzados">
              <i class="bi bi-funnel"></i> Filtros
            </button>
            <button class="btn btn-success" type="button" onclick="exportarAExcel()">
              <i class="bi bi-file-earmark-excel"></i> Exportar
            </button>
            <div class="view-toggle btn-group" role="group">
              <button id="listViewBtn" type="button" class="btn btn-outline-secondary" title="Vista de lista">
                <i class="bi bi-list"></i>
              </button>
              <button id="cardViewBtn" type="button" class="btn btn-outline-secondary" title="Vista de tarjetas">
                <i class="bi bi-grid-3x3-gap-fill"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Filtros avanzados colapsables -->
        <div class="collapse" id="filtrosAvanzados">
          <div class="filtros-avanzados">
            <div class="row">
              <div class="col-md-3">
                <label class="form-label">Estado</label>
                <select class="form-select" id="filtroEstado">
                  <option value="">Todos los estados</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Unidad Gestora</label>
                <select class="form-select" id="filtroUnidadGestion">
                  <option value="">Todas las unidades</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Autor</label>
                <input type="text" class="form-control" id="filtroAutor" placeholder="Nombre del autor">
              </div>
              <div class="col-md-3">
                <label class="form-label">Fecha desde</label>
                <input type="date" class="form-control" id="filtroFechaDesde">
              </div>
            </div>
            <div class="row">
              <div class="col-md-3">
                <label class="form-label">Fecha hasta</label>
                <input type="date" class="form-control" id="filtroFechaHasta">
              </div>
              <div class="col-md-3">
                <label class="form-label">Tipo de actividad</label>
                <select class="form-select" id="filtroTipoActividad">
                  <option value="">Todos los tipos</option>
                </select>
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-primary me-2" onclick="aplicarFiltros()">
                  <i class="bi bi-search"></i> Aplicar filtros
                </button>
                <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                  <i class="bi bi-x-circle"></i> Limpiar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Controles de ordenaci√≥n -->
        <div class="ordenacion-controls">
          <label class="form-label mb-0">Ordenar por:</label>
          <select class="form-select" id="ordenacionCampo">
            <option value="fechaModificacion">Fecha de modificaci√≥n</option>
            <option value="fechaCreacion">Fecha de creaci√≥n</option>
            <option value="titulo">T√≠tulo</option>
            <option value="estado">Estado</option>
            <option value="unidadGestion">Unidad gestora</option>
          </select>
          <select class="form-select" id="ordenacionDireccion">
            <option value="desc">Descendente (m√°s reciente)</option>
            <option value="asc">Ascendente (m√°s antiguo)</option>
          </select>
        </div>

        <!-- Lista de propuestas -->
        <div id="proposalList" data-view="list"></div>
        <nav class="mt-3" aria-label="Paginaci√≥n">
          <ul class="pagination justify-content-center" id="historicoPager"></ul>
        </nav>
      </main>
    </div>
  </div>
  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Cargamos el men√∫ lateral reutilizable -->
  <script src="auth.js"></script>
  <script src="menu.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (typeof Auth !== 'undefined') { Auth.requireAuth(); }
      loadSidebarMenu('sidebarContainer');
    });
  </script>
  <!-- Cargamos la cabecera reutilizable -->
  <script src="header.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      loadHeader('headerContainer');
    });
  </script>
  <!-- Script para cambiar la vista y cargar datos del backend -->
  <script>
    console.log("üî•üî•üî• HISTORICO.HTML CARGADO - VERSI√ìN 2.1 - TIMESTAMP:", new Date().getTime());
    const listBtn = document.getElementById('listViewBtn');
    const cardBtn = document.getElementById('cardViewBtn');
    const proposalList = document.getElementById('proposalList');
    const BUSCADOR = document.getElementById('buscador');
    const API_BASE_URL = (function(){
      try {
        if (typeof CONFIG !== 'undefined' && CONFIG && CONFIG.API_BASE_URL) return CONFIG.API_BASE_URL;
        const o = (typeof window !== 'undefined' && window.location && window.location.origin) ? window.location.origin : 'http://localhost';
        return `${o.replace(/\/$/, '')}/api`;
      } catch {
        return '/api';
      }
    })();
    let actividades = [];
    let paginaActual = 1;
    const pageSize = 50;
    let totalPaginas = 1;
    let filtros = {
      estado: '',
      unidadGestion: '',
      autor: '',
      fechaDesde: '',
      fechaHasta: '',
      tipoActividad: '',
      search: ''
    };
    let ordenacion = {
      campo: 'fechaModificacion',
      direccion: 'desc'
    };
    
    function setView(view) {
      proposalList.setAttribute('data-view', view);
      if (view === 'list') {
        listBtn.classList.add('active');
        cardBtn.classList.remove('active');
      } else {
        cardBtn.classList.add('active');
        listBtn.classList.remove('active');
      }
    }
    listBtn.addEventListener('click', () => setView('list'));
    cardBtn.addEventListener('click', () => setView('cards'));
    // Inicializamos la vista por defecto
    setView('list');

    // Cargar dominios para filtros
    async function cargarDominios() {
      try {
        // Cargar estados (workflow preferente)
        let estados = [];
        try {
          const respEstadosWF = await fetch(`${API_BASE_URL}/workflow/estados`, { 
            headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
          });
          if (respEstadosWF.ok) {
            estados = await respEstadosWF.json();
          }
        } catch {}
        if (!Array.isArray(estados) || !estados.length) {
          const respEstados = await fetch(`${API_BASE_URL}/estados`, { 
            headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
          });
          if (respEstados.ok) estados = await respEstados.json();
        }
        if (Array.isArray(estados) && estados.length) {
          window.__workflowEstados = estados;
          const selectEstado = document.getElementById('filtroEstado');
          estados.forEach(estado => {
            const option = document.createElement('option');
            option.value = estado.id;
            option.textContent = estado.nombre;
            selectEstado.appendChild(option);
          });
        }

        // Cargar unidades de gesti√≥n
        const respUG = await fetch(`${API_BASE_URL}/unidades-gestion`, { 
          headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
        });
        if (respUG.ok) {
          const unidades = await respUG.json();
          const selectUG = document.getElementById('filtroUnidadGestion');
          unidades.forEach(ug => {
            const option = document.createElement('option');
            option.value = ug.id;
            option.textContent = ug.nombre;
            selectUG.appendChild(option);
          });
        }

        // Cargar tipos de actividad
        const respTipos = await fetch(`${API_BASE_URL}/dominios/TIPOS_ACTIVIDAD/valores`, { 
          headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
        });
        if (respTipos.ok) {
          const tipos = await respTipos.json();
          const selectTipo = document.getElementById('filtroTipoActividad');
          tipos.forEach(tipo => {
            const option = document.createElement('option');
            option.value = tipo.valor;
            option.textContent = tipo.descripcion;
            selectTipo.appendChild(option);
          });
        }
      } catch (e) {
        console.error('Error cargando dominios:', e);
      }
    }

    // Cargar actividades desde backend
    async function cargarActividadesHistorico() {
      console.log("üöÄ cargarActividadesHistorico - Iniciando...");
      try {
        renderLoading();
        const url = new URL('/api/actividades', window.location.origin);
        
        // Aplicar filtros
        if (filtros.search) url.searchParams.set('search', filtros.search);
        if (filtros.estado) url.searchParams.set('estado', filtros.estado);
        if (filtros.unidadGestion) url.searchParams.set('ug', filtros.unidadGestion);
        if (filtros.tipoActividad) url.searchParams.set('tipoActividad', filtros.tipoActividad);
        if (filtros.fechaDesde) url.searchParams.set('fechaDesde', filtros.fechaDesde);
        if (filtros.fechaHasta) url.searchParams.set('fechaHasta', filtros.fechaHasta);
        if (filtros.autor) url.searchParams.set('autor', filtros.autor);
        
        // Aplicar ordenaci√≥n
        url.searchParams.set('ordenarPor', ordenacion.campo);
        url.searchParams.set('orden', ordenacion.direccion);
        
        // Paginaci√≥n
        url.searchParams.set('page', String(paginaActual));
        url.searchParams.set('pageSize', String(pageSize));
        
        console.log("üöÄ cargarActividadesHistorico - URL:", url.toString());
        const resp = await fetch(url.toString(), { 
          headers: { 
            'Accept': 'application/json',
            'Authorization': `Bearer ${Auth.getToken()}`
          } 
        });
        console.log("üöÄ cargarActividadesHistorico - Response status:", resp.status);
        if (!resp.ok) {
          let detailMsg = '';
          try {
            const ct = resp.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
              const errJson = await resp.json();
              detailMsg = errJson.detail || errJson.title || JSON.stringify(errJson);
            } else {
              detailMsg = await resp.text();
            }
          } catch (_) {
            // Ignorar errores al parsear el cuerpo
          }
          console.error('‚ùå Detalle API /actividades:', detailMsg || `(sin cuerpo, status ${resp.status})`);
          throw new Error(`HTTP ${resp.status}${detailMsg ? ` - ${detailMsg}` : ''}`);
        }
        const data = await resp.json();
        actividades = Array.isArray(data) ? data : (data.items || []);
        totalPaginas = Array.isArray(data) ? 1 : (data.totalPages || 1);
        console.log("üöÄ cargarActividadesHistorico - Datos recibidos:", actividades.length, "actividades");
        renderActividades();
        renderPaginacion();
      } catch (e) {
        console.error('‚ùå Error cargando actividades:', e);
        console.error('‚ùå Error stack:', e.stack);
        renderError(e?.message || 'Error cargando actividades');
      }
    }

    function aplicarFiltros() {
      filtros.estado = document.getElementById('filtroEstado').value;
      filtros.unidadGestion = document.getElementById('filtroUnidadGestion').value;
      filtros.autor = document.getElementById('filtroAutor').value;
      filtros.fechaDesde = document.getElementById('filtroFechaDesde').value;
      filtros.fechaHasta = document.getElementById('filtroFechaHasta').value;
      filtros.tipoActividad = document.getElementById('filtroTipoActividad').value;
      filtros.search = BUSCADOR.value.trim();
      
      paginaActual = 1; // Resetear a primera p√°gina
      cargarActividadesHistorico();
    }

    function limpiarFiltros() {
      document.getElementById('filtroEstado').value = '';
      document.getElementById('filtroUnidadGestion').value = '';
      document.getElementById('filtroAutor').value = '';
      document.getElementById('filtroFechaDesde').value = '';
      document.getElementById('filtroFechaHasta').value = '';
      document.getElementById('filtroTipoActividad').value = '';
      BUSCADOR.value = '';
      
      filtros = {
        estado: '',
        unidadGestion: '',
        autor: '',
        fechaDesde: '',
        fechaHasta: '',
        tipoActividad: '',
        search: ''
      };
      
      paginaActual = 1;
      cargarActividadesHistorico();
    }

    function aplicarOrdenacion() {
      ordenacion.campo = document.getElementById('ordenacionCampo').value;
      ordenacion.direccion = document.getElementById('ordenacionDireccion').value;
      paginaActual = 1;
      cargarActividadesHistorico();
    }

    // Exportar a Excel
    function exportarAExcel() {
      try {
        // Preparar datos para exportar
        const datosExportar = actividades.map(a => ({
          'ID': a.id,
          'C√≥digo': a.codigo || '',
          'T√≠tulo': a.titulo || '',
          'Descripci√≥n': a.descripcion || '',
          'Estado': a.estado?.nombre || '',
          'Unidad Gestora': a.unidadGestion?.nombre || '',
          'Fecha Inicio': a.fechaInicio ? new Date(a.fechaInicio).toLocaleDateString() : '',
          'Fecha Fin': a.fechaFin ? new Date(a.fechaFin).toLocaleDateString() : '',
          'Fecha Modificaci√≥n': a.fechaModificacion ? new Date(a.fechaModificacion).toLocaleDateString() : '',
          'Fecha Creaci√≥n': a.fechaCreacion ? new Date(a.fechaCreacion).toLocaleDateString() : '',
          'Tipo Actividad': a.tipoActividad || '',
          'A√±o Acad√©mico': a.anioAcademico || '',
          'Plazas Totales': a.plazasTotales || '',
          'Horas Totales': a.horasTotales || ''
        }));

        // Crear workbook y worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(datosExportar);

        // Ajustar anchos de columna
        const colWidths = [
          { wch: 8 },   // ID
          { wch: 15 },  // C√≥digo
          { wch: 40 },  // T√≠tulo
          { wch: 50 },  // Descripci√≥n
          { wch: 15 },  // Estado
          { wch: 25 },  // Unidad Gestora
          { wch: 12 },  // Fecha Inicio
          { wch: 12 },  // Fecha Fin
          { wch: 15 },  // Fecha Modificaci√≥n
          { wch: 15 },  // Fecha Creaci√≥n
          { wch: 20 },  // Tipo Actividad
          { wch: 12 },  // A√±o Acad√©mico
          { wch: 12 },  // Plazas Totales
          { wch: 12 }   // Horas Totales
        ];
        ws['!cols'] = colWidths;

        // A√±adir worksheet al workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Actividades');

        // Generar nombre de archivo con fecha
        const fecha = new Date().toISOString().split('T')[0];
        const nombreArchivo = `Actividades_UB_${fecha}.xlsx`;

        // Descargar archivo
        XLSX.writeFile(wb, nombreArchivo);

        // Mostrar mensaje de √©xito
        alert(`Archivo exportado correctamente: ${nombreArchivo}`);
      } catch (e) {
        console.error('Error exportando a Excel:', e);
        alert('Error al exportar a Excel. Revisa la consola para m√°s detalles.');
      }
    }

    const ESTADO_BADGE = {
      1: 'bg-secondary',            // Borrador
      2: 'bg-warning text-dark',    // Enviada
      3: 'bg-info',                 // En revisi√≥n
      4: 'bg-success',              // Validaci√≥n de unidad
      5: 'bg-primary',              // Definici√≥n
      6: 'bg-warning',              // Revisi√≥n administrativa
      7: 'bg-primary',              // Publicada
      8: 'bg-dark',                 // Cancelada
      9: 'bg-danger'                // Rechazada
    };

    function getEstadoColorByNombre(nombre) {
      try {
        const arr = Array.isArray(window.__workflowEstados) ? window.__workflowEstados : [];
        const n = (nombre || '').trim().toLowerCase();
        const found = arr.find(e => (e.nombre || '').trim().toLowerCase() === n);
        return found?.color || '#6c757d';
      } catch { return '#6c757d'; }
    }

    function getTipoIconClass(tipo) {
      const n = (tipo || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
      if (n.includes('curso')) return 'bi-book';
      if (n.includes('taller')) return 'bi-gear';
      if (n.includes('seminario')) return 'bi-easel';
      if (n.includes('jornada')) return 'bi-people';
      if (n.includes('confer') || n.includes('charla')) return 'bi-mic';
      if (n.includes('webin') || n.includes('online')) return 'bi-camera-video';
      if (n.includes('presencial')) return 'bi-geo-alt';
      if (n.includes('mixto') || n.includes('hibrid')) return 'bi-layers';
      if (n.includes('certif') || n.includes('acredit')) return 'bi-award';
      return 'bi-tag';
    }

    function renderLoading() {
      proposalList.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="bi bi-hourglass-split"></i> Cargando actividades...
        </div>`;
    }

    function renderError(msg) {
      proposalList.innerHTML = `
        <div class="alert alert-danger" role="alert">${msg}</div>`;
    }

    function renderActividades() {
      console.log("üöÄ RENDER ACTIVIDADES - Versi√≥n 2.0 - Iniciando renderizado...");
      console.log("üöÄ Total actividades:", actividades?.length || 0);
      
      if (!actividades || actividades.length === 0) {
        proposalList.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="bi bi-inbox"></i> No se encontraron actividades
          </div>`;
        return;
      }

      const html = actividades.map(a => {
        // Debug: mostrar informaci√≥n del estado para TODAS las actividades
        console.log(`üîç DEBUG Actividad #${a.id}:`, {
          estadoId: a.estado?.id,
          estadoNombre: a.estado?.nombre,
          estadoCompleto: a.estado
        });
        
        // Verificar si la actividad est√° en estado "Publicada" (m√∫ltiples verificaciones)
        const isPublicada = a.estado?.id === 7 || 
                           a.estado?.nombre?.toLowerCase() === 'publicada' ||
                           a.estado?.nombre?.toLowerCase().includes('publicada');
        
        if (isPublicada) {
          console.log(`‚úÖ ACTIVIDAD PUBLICADA DETECTADA #${a.id}:`, {
            estadoId: a.estado?.id,
            estadoNombre: a.estado?.nombre,
            isPublicada: isPublicada
          });
        }
        
        return `
        <div class="proposal-item">
          <a href="editar-actividad.html?id=${a.id}" class="proposal-link">
            <div class="proposal-content">
              <div class="fw-semibold">#${a.id} ¬∑ ${escapeHtml(a.titulo || 'Sin t√≠tulo')}</div>
              <div class="small text-muted">
                <i class="bi ${getTipoIconClass(a.tipoActividad)}"></i> ${escapeHtml(a.tipoActividad || 'Sin tipo')}
              </div>
              <div class="text-muted" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${escapeHtml(a.descripcion || '')}</div>
            </div>
          </a>
          <div class="proposal-meta d-flex align-items-center gap-2 mt-2">
            <span class="badge" style="background-color: ${getEstadoColorByNombre(a.estado?.nombre)};">${a.estado?.nombre || 'Estado'}</span>
            ${isPublicada ? `<a href="detalle-publico.html?id=${a.id}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver en oferta p√∫blica">
              <i class="bi bi-globe"></i>
            </a>` : ''}
            <span class="badge bg-info">${a.unidadGestion?.nombre || 'Unidad'}</span>
          </div>
        </div>
      `;
      }).join('');
      proposalList.innerHTML = html;
    }

    function renderPaginacion() {
      const pager = document.getElementById('historicoPager');
      if (!pager) return;
      if (totalPaginas <= 1) { pager.innerHTML = ''; return; }
      let html = '';
      html += `
        <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="return cambiarPaginaHistorico(${paginaActual - 1})">Anterior</a>
        </li>`;
      const maxVisible = 7;
      let start = Math.max(1, paginaActual - Math.floor(maxVisible/2));
      let end = Math.min(totalPaginas, start + maxVisible - 1);
      if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);
      for (let i = start; i <= end; i++) {
        html += `
          <li class="page-item ${i === paginaActual ? 'active' : ''}">
            <a class="page-link" href="#" onclick="return cambiarPaginaHistorico(${i})">${i}</a>
          </li>`;
      }
      html += `
        <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="return cambiarPaginaHistorico(${paginaActual + 1})">Siguiente</a>
        </li>`;
      pager.innerHTML = html;
    }

    window.cambiarPaginaHistorico = function(page) {
      if (page < 1 || page > totalPaginas || page === paginaActual) return false;
      paginaActual = page;
      cargarActividadesHistorico();
      return false;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // Eventos
    if (BUSCADOR) {
      BUSCADOR.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          filtros.search = BUSCADOR.value.trim();
          paginaActual = 1;
          cargarActividadesHistorico();
        }
      });
    }

    // Eventos de ordenaci√≥n
    document.getElementById('ordenacionCampo').addEventListener('change', aplicarOrdenacion);
    document.getElementById('ordenacionDireccion').addEventListener('change', aplicarOrdenacion);

    // Arranque
    document.addEventListener('DOMContentLoaded', function() {
      console.log("üöÄ DOMContentLoaded - Iniciando carga...");
      try {
        cargarDominios();
        cargarActividadesHistorico();
      } catch (error) {
        console.error("‚ùå ERROR en DOMContentLoaded:", error);
      }
    });
  </script>
  
  <!-- Scripts para men√∫ y funcionalidad -->
  <script src="auth.js"></script>
  <script src="menu.js"></script>
  <script src="header.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      loadSidebarMenu('sidebarContainer');
      loadHeader('headerContainer');
      
      // Requiere login
      if (typeof Auth !== 'undefined') { Auth.requireAuth(); }
    });
  </script>
</main>
</div>
</div>
</body>
</html>
