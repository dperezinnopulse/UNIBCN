<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Alta de Actividad - UB</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

<link href="css/styles.css" rel="stylesheet"/>
<style>
/* Colores para campos específicos por UG */
[data-ug="IDP"]{ border:1px solid #000000 !important; border-left:6px solid #0f172a; border-radius:10px; padding:12px; background:#f8fafc; }
[data-ug="CRAI"]{ border:1px solid #93c5fd; border-left:6px solid #3b82f6; border-radius:10px; padding:12px; background:#eff6ff; }
[data-ug="SAE"]{ border:1px solid #86efac; border-left:6px solid #10b981; border-radius:10px; padding:12px; background:#ecfdf5; }
</style>
</head>
<body>
<script>
  (function(){
    try {
      var token = sessionStorage.getItem('ub_token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
    } catch (e) {
      window.location.href = 'login.html';
    }
  })();
</script>

<div class="d-flex">
<div id="sidebarContainer"></div>
<div class="flex-grow-1 main-content-wrapper">
<div id="headerContainer"></div>

<main class="p-4">
<div class="bg-white rounded shadow p-3 mb-3" id="cabeceraPropuesta">
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
<div class="d-flex align-items-center gap-3 flex-wrap">
<span class="badge px-3 py-2" id="estadoBadge" style="background:#6c757d; font-weight:600;">Borrador</span>
<div class="text-muted small"><i class="bi bi-calendar3 me-1"></i><span id="fechaCreacion">—</span></div>
<div class="text-muted small"><i class="bi bi-clock-history me-1"></i>Actualizado <span id="fechaUpdate">hoy</span></div>
<div class="text-muted small"><i class="bi bi-person me-1"></i><span id="responsablePropuesta">Usuario</span></div>
</div>
<div class="d-flex align-items-center gap-2">
<a class="btn btn-outline-secondary btn-sm" href="historico.html"><i class="bi bi-arrow-left"></i> Volver</a>
</div>
</div>
</div>

<div class="bg-white rounded shadow p-4 mb-5">
<h2 class="h5 mb-4 text-primary">Información general</h2>
<div class="row g-3">
<div class="col-md-4"><label class="form-label">Código de la actividad</label><input class="form-control" id="actividadCodigo" type="text"/></div>
<div class="col-md-4"><label class="form-label">Título de la actividad</label><input class="form-control" id="actividadTitulo" type="text" required/></div>
<div class="col-md-4"><label class="form-label">Tipo de actividad</label><select class="form-select" id="tipoActividad"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label" for="actividadUnidadGestion">Unidad gestora</label><select class="form-select" id="actividadUnidadGestion" required><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Unidad gestora detalle</label><select class="form-select" id="unidadGestoraDetalle"><option value="">Selecciona</option></select></div>
<div class="col-12"><label class="form-label">Descripción</label><textarea class="form-control" id="descripcion" rows="3"></textarea></div>
<div class="col-md-4"><label class="form-label">Año académico</label><input class="form-control" id="actividadAnioAcademico" placeholder="2025-2026" type="text"/></div>
<div class="col-md-4"><label class="form-label">Línea estratégica</label><select class="form-select" id="lineaEstrategica"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Objetivo estratégico</label><select class="form-select" id="objetivoEstrategico"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Código relacionado</label><input class="form-control" id="codigoRelacionado" type="text"/></div>
<div class="col-md-4"><label class="form-label">Actividad reservada</label><select class="form-select" id="actividadReservada"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Fecha Cierre de actividad</label><input class="form-control" id="fechaActividad" type="date"/></div>
<div class="col-md-4"><label class="form-label">Motivo de cierre</label><input class="form-control" id="motivoCierre" type="text"/></div>
<div class="col-md-4"><label class="form-label">Persona solicitante</label><input class="form-control" id="personaSolicitante" type="text" disabled/></div>
<div class="col-md-4"><label class="form-label">Jefe/a unidad gestora</label><select class="form-select" id="jefeUnidadGestora"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Gestor/a de la actividad</label><select class="form-select" id="gestorActividad"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Facultad destinataria</label><select class="form-select" id="facultadDestinataria"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Departamento destinatario</label><select class="form-select" id="departamentoDestinatario"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Centro/unidad UB destinataria</label><select class="form-select" id="centroUnidadUBDestinataria"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Otros centros/instituciones</label><input class="form-control" id="otrosCentrosInstituciones" type="text"/></div>
<div class="col-md-4"><label class="form-label">Plazas totales</label><input class="form-control" id="plazasTotales" type="number" min="0" step="1" inputmode="numeric"/></div>
<div class="col-md-4"><label class="form-label">Horas totales</label><input class="form-control" id="horasTotales" type="number" min="0" step="0.5" inputmode="decimal"/></div>
<div class="col-md-4"><label class="form-label">Modalidad de gestión</label><select class="form-select" id="modalidadGestion"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">F. inicio de la imp.</label><input class="form-control" id="fechaInicioImparticion" type="date"/></div>
<div class="col-md-4"><label class="form-label">F. final de la imp.</label><input class="form-control" id="fechaFinImparticion" type="date"/></div>

<div class="col-md-3"><label class="form-label d-block">Preinscripción</label><div class="form-check form-switch"><input class="form-check-input" id="preinscripcion" type="checkbox"/><label class="form-check-label" for="preinscripcion">Activar</label></div></div>
<div class="col-md-3"><label class="form-label">Estado actividad</label><select class="form-select" id="estadoActividad"><option value="">Selecciona</option></select></div>

<div class="col-md-3" data-ug="CRAI"><label class="form-label">Asignatura (CRAI)</label><select class="form-select" id="asignaturaId"><option value="">Selecciona</option></select></div>
<div class="col-md-3" data-ug="CRAI"><label class="form-label">Grupo Asignatura (CRAI)</label><input class="form-control" id="grupoAsignatura" type="text" maxlength="150"/></div>
<div class="col-md-3" data-ug="CRAI"><label class="form-label">Disciplina relacionada (CRAI)</label><select class="form-select" id="disciplinaRelacionadaId"><option value="">Selecciona</option></select></div>

<div class="col-md-6" data-ug="IDP"><label class="form-label">Coordinador/a de centre/unitat (IDP)</label><select class="form-select" id="coordinadorCentreUnitat"><option value="">Selecciona</option></select></div>
<div class="col-md-6" data-ug="IDP"><label class="form-label">Centre de treball de l'alumne (IDP)</label><input class="form-control" id="centreTreballeAlumne"/></div>

<div class="col-md-4" data-ug="CRAI"><label class="form-label">Crèdits totals (CRAI)</label><input class="form-control" id="creditosTotalesCRAI" min="0" step="0.5" type="number"/></div>

<div class="col-md-4" data-ug="SAE"><label class="form-label">Crèdits totals (SAE)</label><input class="form-control" id="creditosTotalesSAE" min="0" step="0.5" type="number"/></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Crèdits mínims (SAE)</label><input class="form-control" id="creditosMinimosSAE" min="0" step="0.5" type="number"/></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Crèdits màxims (SAE)</label><input class="form-control" id="creditosMaximosSAE" min="0" step="0.5" type="number"/></div>
</div>
</div>

<section class="mb-5" id="importeCampos">
<h2 class="h5 mb-3 border-bottom pb-2">Importe y descuentos</h2>
<div class="row g-3">
<div class="col-md-3"><label class="form-label">Importe base (€)</label><input class="form-control" id="imp_base" min="0" step="0.01" type="number" inputmode="decimal"/></div>
<div class="col-md-3"><label class="form-label">Descuento (%)</label><input class="form-control" id="imp_descuento_pct" max="100" min="0" step="1" type="number" inputmode="numeric"/></div>
<div class="col-12"><label class="form-label">Condiciones</label><textarea class="form-control" id="imp_condiciones_es" rows="2"></textarea></div>
</div>
<div class="row g-3 mt-1">
<div class="col-md-3"><label class="form-label">Coste estimado de la actividad (€)</label><input class="form-control" id="costeEstimadoActividad" min="0" step="0.01" type="number" inputmode="decimal"/></div>
<div class="col-md-3"><label class="form-label">Tipos de financiación</label><select class="form-select" id="tiposFinanciacionId"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">Año inicial de financiación</label><input class="form-control" id="anoInicialFinanciacion" type="number" min="2000" max="2100"/></div>
<div class="col-md-3"><label class="form-label">Año final de financiación</label><input class="form-control" id="anoFinalFinanciacion" type="number" min="2000" max="2100"/></div>
<div class="col-md-6"><label class="form-label">Denominación del Descuento</label><select class="form-select" id="denominacionDescuentoIds" multiple><option value="">Selecciona</option></select></div>
<div class="col-md-6"><label class="form-label">Plazas afectadas por el descuento</label><input class="form-control" id="plazasAfectadasDescuento" type="number" min="0"/></div>
</div>
</section>

<section class="mb-5" id="seccion-inscripcion">
<h2 class="h5 mb-3 border-bottom pb-2">Inscripción</h2>
<div class="row g-3">
<div class="col-md-3"><label class="form-label">Inicio inscripción</label><input class="form-control" id="insc_inicio" type="date"/></div>
<div class="col-md-3"><label class="form-label">Fin inscripción</label><input class="form-control" id="insc_fin" type="date"/></div>
<div class="col-md-3"><label class="form-label">Nº de plazas</label><input class="form-control" id="insc_plazas" min="0" step="1" type="number" inputmode="numeric"/></div>
<div class="col-md-3"><label class="form-label d-block">Lista de espera</label><div class="form-check form-switch"><input class="form-check-input" id="insc_lista_espera" type="checkbox"/><label class="form-check-label" for="insc_lista_espera">Activar</label></div></div>
<div class="col-md-4"><label class="form-label">Modalidad</label><select class="form-select" id="insc_modalidad"><option value="">Selecciona</option></select></div>
<div class="col-12"><label class="form-label">Requisitos</label><textarea class="form-control" id="insc_requisitos_es" rows="2"></textarea></div>
<div class="col-md-3"><label class="form-label">Fecha Límite de Pago</label><input class="form-control" id="fechaLimitePago" type="date"/></div>
<div class="col-md-3"><label class="form-label d-block">TPV</label><div class="form-check form-switch"><input class="form-check-input" id="tpv" type="checkbox"/><label class="form-check-label" for="tpv">Activar</label></div></div>
<div class="col-md-3"><label class="form-label">Remesa</label><select class="form-select" id="remesa"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">Tipos de Inscripción</label><select class="form-select" id="tiposInscripcionId"><option value="">Selecciona</option></select></div>
<div class="col-md-6"><label class="form-label">Fecha Adjudicación Preinscripción</label><input class="form-control" id="fechaAdjudicacionPreinscripcion" type="date"/></div>
</div>
</section>

<section class="mb-5" id="seccion-programa">
<h2 class="h5 mb-3 border-bottom pb-2">Programa</h2>
<div class="row g-3">
<div class="col-12"><label class="form-label">Descripción</label><textarea class="form-control" id="programa_descripcion_es" rows="3"></textarea></div>
<div class="col-12"><label class="form-label">Contenidos</label><textarea class="form-control" id="programa_contenidos_es" rows="3"></textarea></div>
<div class="col-12"><label class="form-label">Objetivos</label><textarea class="form-control" id="programa_objetivos_es" rows="3"></textarea></div>
<div class="col-md-4"><label class="form-label">Fecha de inicio</label><input class="form-control" id="programa_inicio" type="date"/></div>
<div class="col-md-4"><label class="form-label">Fecha de fin</label><input class="form-control" id="programa_fin" type="date"/></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Tipus d'estudi (SAE)</label><select class="form-select" id="tipusEstudiSAE"><option value="">Selecciona</option></select></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Categoria (SAE)</label><select class="form-select" id="categoriaSAE"><option value="">Selecciona</option></select></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Competències (SAE)</label><select class="form-select" id="competenciesSAE"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">Idioma de Impartición</label><select class="form-select" id="idiomaImparticionId"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">Tipos de Certificación</label><select class="form-select" id="tiposCertificacionId"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">Materia / Disciplina</label><select class="form-select" id="materiaDisciplinaId"><option value="">Selecciona</option></select></div>
<div class="col-md-3" data-ug="IDP"><label class="form-label">Ámbito de formación (IDP)</label><select class="form-select" id="ambitoFormacionId"><option value="">Selecciona</option></select></div>
<div class="col-12"><label class="form-label">Observaciones</label><textarea class="form-control" id="observaciones" rows="3"></textarea></div>
<div class="col-12"><label class="form-label">Espacio de Impartición</label><textarea class="form-control" id="espacioImparticion" rows="3"></textarea></div>
<div class="col-12"><label class="form-label">Lugar de Impartición</label><textarea class="form-control" id="lugarImparticion" rows="3"></textarea></div>
<div class="col-12"><label class="form-label">Otras Ubicaciones</label><textarea class="form-control" id="otrasUbicaciones" rows="3"></textarea></div>
</div>
</section>

<div class="bg-white rounded shadow p-4">
<section class="mb-5">
<h2 class="h5 mb-3 border-bottom pb-2">Subactividades</h2>
<div class="mb-3" id="subactividadesContainer">
  <div class="card mb-2 shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4"><label class="form-label">Título</label><input class="form-control" id="subactividad_1_titulo" /></div>
        <div class="col-md-4"><label class="form-label">Modalidad</label><select class="form-select" id="subactividad_1_modalidad"><option value="">Selecciona</option></select></div>
        <div class="col-md-4"><label class="form-label">Docente/s</label><input class="form-control" id="subactividad_1_docente" /></div>
        <div class="col-md-3"><label class="form-label">Fecha inicio</label><input type="date" class="form-control" id="subactividad_1_fechaInicio" /></div>
        <div class="col-md-3"><label class="form-label">Fecha fin</label><input type="date" class="form-control" id="subactividad_1_fechaFin" /></div>
        <div class="col-md-3"><label class="form-label">Hora inicio</label><input type="time" class="form-control" id="subactividad_1_horaInicio" /></div>
        <div class="col-md-3"><label class="form-label">Hora fin</label><input type="time" class="form-control" id="subactividad_1_horaFin" /></div>
        <div class="col-md-3"><label class="form-label">Duración (h)</label><input type="number" step="0.5" class="form-control" id="subactividad_1_duracion" /></div>
        <div class="col-md-3"><label class="form-label">Ubicación / Aula</label><input class="form-control" id="subactividad_1_ubicacion" /></div>
        <div class="col-md-3"><label class="form-label">Aforo</label><input type="number" min="0" class="form-control" id="subactividad_1_aforo" /></div>
        <div class="col-md-3"><label class="form-label">Idioma</label><select class="form-select" id="subactividad_1_idioma"><option value="">Selecciona</option></select></div>
        <div class="col-12"><label class="form-label">Descripción</label><textarea class="form-control" rows="2" id="subactividad_1_descripcion"></textarea></div>
      </div>
    </div>
  </div>
</div>
</section>
<section class="mb-5">
<h2 class="h5 mb-3 border-bottom pb-2">Participantes</h2>
<div class="mb-3" id="participantesContainer">
  <div class="row g-2 align-items-end mb-2">
    <div class="col-md-4"><label class="form-label">Nombre</label><input class="form-control" id="participante_1_nombre" /></div>
    <div class="col-md-3"><label class="form-label">Rol</label><select class="form-select" id="participante_1_rol"><option value="">Selecciona</option></select></div>
    <div class="col-md-3"><label class="form-label">Email</label><input type="email" class="form-control" id="participante_1_email" /></div>
  </div>
</div>
</section>
</div>

<div class="d-flex gap-2 mt-4">
<button class="btn btn-primary" id="btnGuardarActividad" type="button">Guardar Actividad</button>
</div>

</main>
</div>
</div>

<script src="menu.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    loadSidebarMenu('sidebarContainer');
  });
</script>
<script src="header.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    loadHeader('headerContainer');
  });
</script>

<!-- Nota: No se incluye scripts-clean.js para evitar cualquier llamada al backend en esta página -->

<!-- Estructuras para posterior rellenado y carga básica de dominios -->
<script>
  window.SelectIds = {
    static: [
      'tipoActividad','actividadUnidadGestion','unidadGestoraDetalle','lineaEstrategica','objetivoEstrategico','actividadReservada',
      'jefeUnidadGestora','gestorActividad','facultadDestinataria','departamentoDestinatario','centroUnidadUBDestinataria',
      'modalidadGestion','estadoActividad','asignaturaId','disciplinaRelacionadaId','idiomaImparticionId','tiposCertificacionId',
      'materiaDisciplinaId','ambitoFormacionId','tiposFinanciacionId','denominacionDescuentoIds','insc_modalidad','remesa','tiposInscripcionId'
    ],
    dynamicPatterns: [
      'subactividad_*_modalidad','subactividad_*_idioma','participante_*_rol'
    ]
  };

  window.UGFields = {
    IDP: ['coordinadorCentreUnitat','centreTreballeAlumne','ambitoFormacionId'],
    CRAI: ['asignaturaId','grupoAsignatura','disciplinaRelacionadaId','creditosTotalesCRAI'],
    SAE: ['creditosTotalesSAE','creditosMinimosSAE','creditosMaximosSAE','tipusEstudiSAE','categoriaSAE','competenciesSAE']
  };

  (function(){
    // Rellenar personaSolicitante con el usuario de sesión
    try {
      const userRaw = sessionStorage.getItem('ub_user');
      if (userRaw) {
        try { const user = JSON.parse(userRaw); const el = document.getElementById('personaSolicitante'); if (el) el.value = (user?.username || user?.name || ''); } catch {}
      }
    } catch {}

    const map = [
      { elementId: 'tipoActividad', dominio: 'TIPOS_ACTIVIDAD' },
      { elementId: 'unidadGestoraDetalle', dominio: 'SUBUNIDAD_GESTORA' },
      { elementId: 'lineaEstrategica', dominio: 'LINEAS_ESTRATEGICAS' },
      { elementId: 'objetivoEstrategico', dominio: 'OBJETIVOS_ESTRATEGICOS' },
      { elementId: 'actividadReservada', dominio: 'ACTIVIDADES_RESERVADAS' },
      { elementId: 'jefeUnidadGestora', dominio: 'JEFES_UNIDAD_GESTORA' },
      { elementId: 'gestorActividad', dominio: 'GESTORES_ACTIVIDAD' },
      { elementId: 'facultadDestinataria', dominio: 'FACULTADES_DESTINATARIAS' },
      { elementId: 'departamentoDestinatario', dominio: 'DEPARTAMENTOS_DESTINATARIOS' },
      { elementId: 'centroUnidadUBDestinataria', dominio: 'CENTROS_UB' },
      { elementId: 'modalidadGestion', dominio: 'MODALIDADES_GESTION' },
      { elementId: 'estadoActividad', dominio: 'EstadoActividad' },
      { elementId: 'coordinadorCentreUnitat', dominio: 'COORDINADORES_CENTRE_UNITAT_IDP' },
      { elementId: 'asignaturaId', dominio: 'Asignatura' },
      { elementId: 'disciplinaRelacionadaId', dominio: 'DisciplinaRelacionada' },
      { elementId: 'idiomaImparticionId', dominio: 'IdiomaImparticion' },
      { elementId: 'tiposCertificacionId', dominio: 'TiposCertificacion' },
      { elementId: 'materiaDisciplinaId', dominio: 'MateriaDisciplina' },
      { elementId: 'ambitoFormacionId', dominio: 'AmbitoFormacion' },
      { elementId: 'tiposFinanciacionId', dominio: 'TiposFinanciacion' },
      { elementId: 'denominacionDescuentoIds', dominio: 'DenominacionDescuento' },
      { elementId: 'insc_modalidad', dominio: 'MODALIDAD_IMPARTICION' },
      { elementId: 'remesa', dominio: 'Remesa' },
      { elementId: 'tiposInscripcionId', dominio: 'TiposInscripcion' },
      { elementId: 'tipusEstudiSAE', dominio: 'TIPUS_ESTUDI_SAE' },
      { elementId: 'categoriaSAE', dominio: 'CATEGORIAS_SAE' },
      { elementId: 'competenciesSAE', dominio: 'COMPETENCIAS_SAE' },
      { elementId: 'subactividad_1_modalidad', dominio: 'MODALIDAD_IMPARTICION' },
      { elementId: 'subactividad_1_idioma', dominio: 'IdiomaImparticion' },
      { elementId: 'participante_1_rol', dominio: 'TIPOS_PARTICIPANTE_ROL' },
    ];

    function setOptions(select, valores){
      if (!select) return;
      const keepFirst = select.firstElementChild && select.firstElementChild.value === '';
      while (select.options.length > (keepFirst?1:0)) select.remove(keepFirst?1:0);
      (valores||[]).forEach(v => {
        const opt = document.createElement('option');
        opt.value = (v.id ?? v.Id ?? '').toString();
        opt.textContent = v.descripcion ?? v.Descripcion ?? v.nombre ?? v.Nombre ?? String(v.id ?? v.Id ?? '');
        select.appendChild(opt);
      });
    }

    function getDominioDesdeCache(nombre){
      try {
        const raw = localStorage.getItem(`dominio_cache_${nombre}`);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    async function cargarDominiosAlta(){
      // UG principal: estático para evitar backend
      try {
        const ug = document.getElementById('actividadUnidadGestion');
        if (ug && ug.options.length <= 1) {
          ['IDP','CRAI','SAE'].forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; ug.appendChild(o); });
        }
      } catch {}

      const presentes = map.filter(m => document.getElementById(m.elementId));
      presentes.forEach(m => {
        const valores = getDominioDesdeCache(m.dominio);
        setOptions(document.getElementById(m.elementId), valores);
      });
    }

    document.addEventListener('DOMContentLoaded', function(){
      try { cargarDominiosAlta(); } catch(e) { console.error(e); }
    });
  })();
</script>

<!-- Helper de traducción eliminado (volveremos a añadirlo campo a campo cuando lo indiques) -->

<!-- Autenticación mínima (para cabecera) -->
<script src="auth.js?v=2.0"></script>

</body>
</html>


