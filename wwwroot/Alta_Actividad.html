<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Alta de Actividad - UB</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

<link href="css/styles.css" rel="stylesheet"/>
<style>
/* Colores para campos espec√≠ficos por UG */
[data-ug="IDP"]{ border:1px solid #000000 !important; border-left:6px solid #0f172a; border-radius:10px; padding:12px; background:#f8fafc; }
[data-ug="CRAI"]{ border:1px solid #93c5fd; border-left:6px solid #3b82f6; border-radius:10px; padding:12px; background:#eff6ff; }
[data-ug="SAE"]{ border:1px solid #86efac; border-left:6px solid #10b981; border-radius:10px; padding:12px; background:#ecfdf5; }
</style>
</head>
<body>
<script>
  (function(){
    try {
      var token = sessionStorage.getItem('ub_token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
    } catch (e) {
      window.location.href = 'login.html';
    }
  })();
</script>

<div class="d-flex">
<div id="sidebarContainer"></div>
<div class="flex-grow-1 main-content-wrapper">
<div id="headerContainer"></div>

<main class="p-4">
<div id="alertContainer" class="mb-3"></div>
<div class="bg-white rounded shadow p-3 mb-3" id="cabeceraPropuesta">
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
<div class="d-flex align-items-center gap-3 flex-wrap">
<span class="badge px-3 py-2" id="estadoBadge" style="background:#6c757d; font-weight:600;">Borrador</span>
<div class="text-muted small"><i class="bi bi-calendar3 me-1"></i><span id="fechaCreacion">‚Äî</span></div>
<div class="text-muted small"><i class="bi bi-clock-history me-1"></i>Actualizado <span id="fechaUpdate">hoy</span></div>
<div class="text-muted small"><i class="bi bi-person me-1"></i><span id="responsablePropuesta">Usuario</span></div>
</div>
<div class="d-flex align-items-center gap-2">
<a class="btn btn-outline-secondary btn-sm" href="historico.html"><i class="bi bi-arrow-left"></i> Volver</a>
</div>
</div>
</div>

<div class="bg-white rounded shadow p-4 mb-5">
<h2 class="h5 mb-4 text-primary">Informaci√≥n general</h2>
<div class="row g-3">
<div class="col-md-4"><label class="form-label">C√≥digo de la actividad</label><input class="form-control" id="actividadCodigo" type="text"/></div>
<div class="col-md-4 position-relative">
<label class="form-label">T√≠tulo de la actividad</label>
<div class="input-group">
<input class="form-control" id="actividadTitulo" type="text" required/>
<span class="input-group-text" onclick="mostrarTraduccion(this)" style="cursor:pointer;">üåê</span>
</div>
<div class="traduccion bg-light p-3 rounded border mt-2 d-none">
<div class="i18n-row mb-2" data-lang="ca">
  <label class="form-label mt-1">Catal√°n</label>
  <input class="form-control" id="actividadTituloCA" type="text"/>
</div>
<div class="i18n-row mb-2" data-lang="es">
  <label class="form-label">Castellano</label>
  <input class="form-control" id="actividadTituloES" type="text"/>
</div>
<div class="i18n-row" data-lang="en">
  <label class="form-label">Ingl√©s</label>
  <input class="form-control" id="actividadTituloEN" type="text"/>
</div>
</div>
</div>
<div class="col-md-4"><label class="form-label">Tipo de actividad</label><select class="form-select" id="tipoActividad"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label" for="actividadUnidadGestion">Unidad gestora</label><select class="form-select" id="actividadUnidadGestion" required><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Unidad gestora detalle</label><select class="form-select" id="unidadGestoraDetalle"><option value="">Selecciona</option></select></div>
<div class="col-12"><label class="form-label">Descripci√≥n</label><textarea class="form-control" id="descripcion" rows="3"></textarea></div>
<div class="col-md-4"><label class="form-label">A√±o acad√©mico</label><input class="form-control" id="actividadAnioAcademico" placeholder="2025-2026" type="text"/></div>
<div class="col-md-4"><label class="form-label">L√≠nea estrat√©gica</label><select class="form-select" id="lineaEstrategica"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Objetivo estrat√©gico</label><select class="form-select" id="objetivoEstrategico"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">C√≥digo relacionado</label><input class="form-control" id="codigoRelacionado" type="text"/></div>
<div class="col-md-4"><label class="form-label">Actividad reservada</label><select class="form-select" id="actividadReservada"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Fecha Cierre de actividad</label><input class="form-control" id="fechaActividad" type="date"/></div>
<div class="col-md-4"><label class="form-label">Motivo de cierre</label><input class="form-control" id="motivoCierre" type="text"/></div>
<div class="col-md-4"><label class="form-label">Persona solicitante</label><input class="form-control" id="personaSolicitante" type="text" disabled/></div>
<div class="col-md-4"><label class="form-label">Jefe/a unidad gestora</label><select class="form-select" id="jefeUnidadGestora"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Gestor/a de la actividad</label><select class="form-select" id="gestorActividad"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Facultad destinataria</label><select class="form-select" id="facultadDestinataria"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Departamento destinatario</label><select class="form-select" id="departamentoDestinatario"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Centro/unidad UB destinataria</label><select class="form-select" id="centroUnidadUBDestinataria"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">Otros centros/instituciones</label><input class="form-control" id="otrosCentrosInstituciones" type="text"/></div>
<div class="col-md-4"><label class="form-label">Plazas totales</label><input class="form-control" id="plazasTotales" type="number" min="0" step="1" inputmode="numeric"/></div>
<div class="col-md-4"><label class="form-label">Horas totales</label><input class="form-control" id="horasTotales" type="number" min="0" step="0.5" inputmode="decimal"/></div>
<div class="col-md-4"><label class="form-label">Modalidad de gesti√≥n</label><select class="form-select" id="modalidadGestion"><option value="">Selecciona</option></select></div>
<div class="col-md-4"><label class="form-label">F. inicio de la imp.</label><input class="form-control" id="fechaInicioImparticion" type="date"/></div>
<div class="col-md-4"><label class="form-label">F. final de la imp.</label><input class="form-control" id="fechaFinImparticion" type="date"/></div>

<div class="col-md-3"><label class="form-label d-block">Preinscripci√≥n</label><div class="form-check form-switch"><input class="form-check-input" id="preinscripcion" type="checkbox"/><label class="form-check-label" for="preinscripcion">Activar</label></div></div>
<div class="col-md-3"><label class="form-label">Estado actividad</label><select class="form-select" id="estadoActividad"><option value="">Selecciona</option></select></div>

<div class="col-md-3" data-ug="CRAI"><label class="form-label">Asignatura (CRAI)</label><select class="form-select" id="asignaturaId"><option value="">Selecciona</option></select></div>
<div class="col-md-3" data-ug="CRAI"><label class="form-label">Grupo Asignatura (CRAI)</label><input class="form-control" id="grupoAsignatura" type="text" maxlength="150"/></div>
<div class="col-md-3" data-ug="CRAI"><label class="form-label">Disciplina relacionada (CRAI)</label><select class="form-select" id="disciplinaRelacionadaId"><option value="">Selecciona</option></select></div>

<div class="col-md-6" data-ug="IDP"><label class="form-label">Coordinador/a de centre/unitat (IDP)</label><select class="form-select" id="coordinadorCentreUnitat"><option value="">Selecciona</option></select></div>
<div class="col-md-6" data-ug="IDP"><label class="form-label">Centre de treball de l'alumne (IDP)</label><input class="form-control" id="centreTreballeAlumne"/></div>

<div class="col-md-4" data-ug="CRAI"><label class="form-label">Cr√®dits totals (CRAI)</label><input class="form-control" id="creditosTotalesCRAI" min="0" step="0.5" type="number"/></div>

<div class="col-md-4" data-ug="SAE"><label class="form-label">Cr√®dits totals (SAE)</label><input class="form-control" id="creditosTotalesSAE" min="0" step="0.5" type="number"/></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Cr√®dits m√≠nims (SAE)</label><input class="form-control" id="creditosMinimosSAE" min="0" step="0.5" type="number"/></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Cr√®dits m√†xims (SAE)</label><input class="form-control" id="creditosMaximosSAE" min="0" step="0.5" type="number"/></div>
</div>
</div>

<section class="mb-5" id="importeCampos">
<h2 class="h5 mb-3 border-bottom pb-2">Importe y descuentos</h2>
<div class="row g-3">
<div class="col-md-3"><label class="form-label">Importe base (‚Ç¨)</label><input class="form-control" id="imp_base" min="0" step="0.01" type="number" inputmode="decimal"/></div>
<div class="col-md-3"><label class="form-label">Descuento (%)</label><input class="form-control" id="imp_descuento_pct" max="100" min="0" step="1" type="number" inputmode="numeric"/></div>
<div class="col-12"><label class="form-label">Condiciones</label><textarea class="form-control" id="imp_condiciones_es" rows="2"></textarea></div>
</div>
<div class="row g-3 mt-1">
<div class="col-md-3"><label class="form-label">Coste estimado de la actividad (‚Ç¨)</label><input class="form-control" id="costeEstimadoActividad" min="0" step="0.01" type="number" inputmode="decimal"/></div>
<div class="col-md-3"><label class="form-label">Tipos de financiaci√≥n</label><select class="form-select" id="tiposFinanciacionId"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">A√±o inicial de financiaci√≥n</label><input class="form-control" id="anoInicialFinanciacion" type="number" min="2000" max="2100"/></div>
<div class="col-md-3"><label class="form-label">A√±o final de financiaci√≥n</label><input class="form-control" id="anoFinalFinanciacion" type="number" min="2000" max="2100"/></div>
<div class="col-md-6"><label class="form-label">Denominaci√≥n del Descuento</label><select class="form-select" id="denominacionDescuentoIds" multiple><option value="">Selecciona</option></select></div>
<div class="col-md-6"><label class="form-label">Plazas afectadas por el descuento</label><input class="form-control" id="plazasAfectadasDescuento" type="number" min="0"/></div>
</div>
</section>

<section class="mb-5" id="seccion-inscripcion">
<h2 class="h5 mb-3 border-bottom pb-2">Inscripci√≥n</h2>
<div class="row g-3">
<div class="col-md-3"><label class="form-label">Inicio inscripci√≥n</label><input class="form-control" id="insc_inicio" type="date"/></div>
<div class="col-md-3"><label class="form-label">Fin inscripci√≥n</label><input class="form-control" id="insc_fin" type="date"/></div>
<div class="col-md-3"><label class="form-label">N¬∫ de plazas</label><input class="form-control" id="insc_plazas" min="0" step="1" type="number" inputmode="numeric"/></div>
<div class="col-md-3"><label class="form-label d-block">Lista de espera</label><div class="form-check form-switch"><input class="form-check-input" id="insc_lista_espera" type="checkbox"/><label class="form-check-label" for="insc_lista_espera">Activar</label></div></div>
<div class="col-md-4"><label class="form-label">Modalidad</label><select class="form-select" id="insc_modalidad"><option value="">Selecciona</option></select></div>
<div class="col-12 position-relative">
<label class="form-label">Requisitos</label>
<div class="input-group">
<textarea class="form-control" id="insc_requisitos_es" placeholder="Requisitos (ES)" rows="2"></textarea>
<span class="input-group-text" onclick="mostrarTraduccion(this)" style="cursor:pointer;">üåê</span>
</div>
<div class="traduccion d-none position-absolute bg-white border rounded p-3 shadow" style="z-index:10; right:0; width: min(520px, 92vw);">
  <div class="i18n-row mb-2" data-lang="ca">
    <small class="text-muted">Catal√†</small>
    <textarea class="form-control" id="insc_requisitos_ca" placeholder="Requisits (CA)" rows="2"></textarea>
  </div>
  <div class="i18n-row mb-2" data-lang="es">
    <small class="text-muted">Castellano</small>
    <textarea class="form-control" id="insc_requisitos_es_dup" placeholder="Requisitos (ES)" rows="2"></textarea>
  </div>
  <div class="i18n-row" data-lang="en">
    <small class="text-muted">English</small>
    <textarea class="form-control" id="insc_requisitos_en" placeholder="Requirements (EN)" rows="2"></textarea>
  </div>
</div>
</div>
<div class="col-md-3"><label class="form-label">Fecha L√≠mite de Pago</label><input class="form-control" id="fechaLimitePago" type="date"/></div>
<div class="col-md-3"><label class="form-label d-block">TPV</label><div class="form-check form-switch"><input class="form-check-input" id="tpv" type="checkbox"/><label class="form-check-label" for="tpv">Activar</label></div></div>
<div class="col-md-3"><label class="form-label">Remesa</label><select class="form-select" id="remesa"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">Tipos de Inscripci√≥n</label><select class="form-select" id="tiposInscripcionId"><option value="">Selecciona</option></select></div>
<div class="col-md-6"><label class="form-label">Fecha Adjudicaci√≥n Preinscripci√≥n</label><input class="form-control" id="fechaAdjudicacionPreinscripcion" type="date"/></div>
</div>
</section>

<section class="mb-5" id="seccion-programa">
<h2 class="h5 mb-3 border-bottom pb-2">Programa</h2>
<div class="row g-3">
<div class="col-12 position-relative">
<label class="form-label">Descripci√≥n</label>
<div class="input-group">
<textarea class="form-control" id="programa_descripcion_es" placeholder="Descripci√≥n (ES)" rows="3"></textarea>
<span class="input-group-text" onclick="mostrarTraduccion(this)" style="cursor:pointer;">üåê</span>
</div>
<div class="traduccion d-none position-absolute bg-white border rounded p-3 shadow" style="z-index:10; right:0; width: min(520px, 92vw);">
  <div class="i18n-row mb-2" data-lang="ca">
    <small class="text-muted">Catal√†</small>
    <textarea class="form-control" id="programa_descripcion_ca" placeholder="Descripci√≥ (CA)" rows="2"></textarea>
  </div>
  <div class="i18n-row mb-2" data-lang="es">
    <small class="text-muted">Castellano</small>
    <textarea class="form-control" id="programa_descripcion_es_dup" placeholder="Descripci√≥n (ES)" rows="2"></textarea>
  </div>
  <div class="i18n-row" data-lang="en">
    <small class="text-muted">English</small>
    <textarea class="form-control" id="programa_descripcion_en" placeholder="Description (EN)" rows="2"></textarea>
  </div>
</div>
</div>
<div class="col-12 position-relative">
<label class="form-label">Contenidos</label>
<div class="input-group">
<textarea class="form-control" id="programa_contenidos_es" placeholder="Contenidos (ES)" rows="3"></textarea>
<span class="input-group-text" onclick="mostrarTraduccion(this)" style="cursor:pointer;">üåê</span>
</div>
<div class="traduccion d-none position-absolute bg-white border rounded p-3 shadow" style="z-index:10; right:0; width: min(520px, 92vw);">
  <div class="i18n-row mb-2" data-lang="ca">
    <small class="text-muted">Catal√†</small>
    <textarea class="form-control" id="programa_contenidos_ca" placeholder="Continguts (CA)" rows="2"></textarea>
  </div>
  <div class="i18n-row mb-2" data-lang="es">
    <small class="text-muted">Castellano</small>
    <textarea class="form-control" id="programa_contenidos_es_dup" placeholder="Contenidos (ES)" rows="2"></textarea>
  </div>
  <div class="i18n-row" data-lang="en">
    <small class="text-muted">English</small>
    <textarea class="form-control" id="programa_contenidos_en" placeholder="Contents (EN)" rows="2"></textarea>
  </div>
</div>
</div>
<div class="col-12 position-relative">
<label class="form-label">Objetivos</label>
<div class="input-group">
<textarea class="form-control" id="programa_objetivos_es" placeholder="Objetivos (ES)" rows="3"></textarea>
<span class="input-group-text" onclick="mostrarTraduccion(this)" style="cursor:pointer;">üåê</span>
</div>
<div class="traduccion d-none position-absolute bg-white border rounded p-3 shadow" style="z-index:10; right:0; width: min(520px, 92vw);">
  <div class="i18n-row mb-2" data-lang="ca">
    <small class="text-muted">Catal√†</small>
    <textarea class="form-control" id="programa_objetivos_ca" placeholder="Objectius (CA)" rows="2"></textarea>
  </div>
  <div class="i18n-row mb-2" data-lang="es">
    <small class="text-muted">Castellano</small>
    <textarea class="form-control" id="programa_objetivos_es_dup" placeholder="Objetivos (ES)" rows="2"></textarea>
  </div>
  <div class="i18n-row" data-lang="en">
    <small class="text-muted">English</small>
    <textarea class="form-control" id="programa_objetivos_en" placeholder="Objectives (EN)" rows="2"></textarea>
  </div>
</div>
</div>
<div class="col-md-4"><label class="form-label">Fecha de inicio</label><input class="form-control" id="programa_inicio" type="date"/></div>
<div class="col-md-4"><label class="form-label">Fecha de fin</label><input class="form-control" id="programa_fin" type="date"/></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Tipus d'estudi (SAE)</label><select class="form-select" id="tipusEstudiSAE"><option value="">Selecciona</option></select></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Categoria (SAE)</label><select class="form-select" id="categoriaSAE"><option value="">Selecciona</option></select></div>
<div class="col-md-4" data-ug="SAE"><label class="form-label">Compet√®ncies (SAE)</label><select class="form-select" id="competenciesSAE"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">Idioma de Impartici√≥n</label><select class="form-select" id="idiomaImparticionId"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">Tipos de Certificaci√≥n</label><select class="form-select" id="tiposCertificacionId"><option value="">Selecciona</option></select></div>
<div class="col-md-3"><label class="form-label">Materia / Disciplina</label><select class="form-select" id="materiaDisciplinaId"><option value="">Selecciona</option></select></div>
<div class="col-md-3" data-ug="IDP"><label class="form-label">√Åmbito de formaci√≥n (IDP)</label><select class="form-select" id="ambitoFormacionId"><option value="">Selecciona</option></select></div>
<div class="col-12"><label class="form-label">Observaciones</label><textarea class="form-control" id="observaciones" rows="3"></textarea></div>
<div class="col-12"><label class="form-label">Espacio de Impartici√≥n</label><textarea class="form-control" id="espacioImparticion" rows="3"></textarea></div>
<div class="col-12"><label class="form-label">Lugar de Impartici√≥n</label><textarea class="form-control" id="lugarImparticion" rows="3"></textarea></div>
<div class="col-12"><label class="form-label">Otras Ubicaciones</label><textarea class="form-control" id="otrasUbicaciones" rows="3"></textarea></div>
</div>
</section>

<div class="bg-white rounded shadow p-4">
<section class="mb-5">
<h2 class="h5 mb-3 border-bottom pb-2">Subactividades</h2>
<div class="mb-3" id="subactividadesContainer">
  <div class="card mb-2 shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4"><label class="form-label">T√≠tulo</label><input class="form-control" id="subactividad_1_titulo" /></div>
        <div class="col-md-4"><label class="form-label">Modalidad</label><select class="form-select" id="subactividad_1_modalidad"><option value="">Selecciona</option></select></div>
        <div class="col-md-4"><label class="form-label">Docente/s</label><input class="form-control" id="subactividad_1_docente" /></div>
        <div class="col-md-3"><label class="form-label">Fecha inicio</label><input type="date" class="form-control" id="subactividad_1_fechaInicio" /></div>
        <div class="col-md-3"><label class="form-label">Fecha fin</label><input type="date" class="form-control" id="subactividad_1_fechaFin" /></div>
        <div class="col-md-3"><label class="form-label">Hora inicio</label><input type="time" class="form-control" id="subactividad_1_horaInicio" /></div>
        <div class="col-md-3"><label class="form-label">Hora fin</label><input type="time" class="form-control" id="subactividad_1_horaFin" /></div>
        <div class="col-md-3"><label class="form-label">Duraci√≥n (h)</label><input type="number" step="0.5" class="form-control" id="subactividad_1_duracion" /></div>
        <div class="col-md-3"><label class="form-label">Ubicaci√≥n / Aula</label><input class="form-control" id="subactividad_1_ubicacion" /></div>
        <div class="col-md-3"><label class="form-label">Aforo</label><input type="number" min="0" class="form-control" id="subactividad_1_aforo" /></div>
        <div class="col-md-3"><label class="form-label">Idioma</label><select class="form-select" id="subactividad_1_idioma"><option value="">Selecciona</option></select></div>
        <div class="col-12"><label class="form-label">Descripci√≥n</label><textarea class="form-control" rows="2" id="subactividad_1_descripcion"></textarea></div>
      </div>
    </div>
  </div>
</div>
</section>
<section class="mb-5">
<h2 class="h5 mb-3 border-bottom pb-2">Participantes</h2>
<div class="mb-3" id="participantesContainer">
  <div class="row g-2 align-items-end mb-2">
    <div class="col-md-4"><label class="form-label">Nombre</label><input class="form-control" id="participante_1_nombre" /></div>
    <div class="col-md-3"><label class="form-label">Rol</label><select class="form-select" id="participante_1_rol"><option value="">Selecciona</option></select></div>
    <div class="col-md-3"><label class="form-label">Email</label><input type="email" class="form-control" id="participante_1_email" /></div>
  </div>
</div>
</section>
</div>

<div class="d-flex gap-2 mt-4">
<button class="btn btn-primary" id="btnGuardarActividad" type="button">Guardar Actividad</button>
</div>

</main>
</div>
</div>

<script src="menu.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    loadSidebarMenu('sidebarContainer');
  });
</script>
<script src="header.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    loadHeader('headerContainer');
  });
</script>

<!-- Nota: No se incluye scripts-clean.js para evitar cualquier llamada al backend en esta p√°gina -->

<!-- Estructuras para posterior rellenado y carga b√°sica de dominios -->
<script>
  window.SelectIds = {
    static: [
      'tipoActividad','actividadUnidadGestion','unidadGestoraDetalle','lineaEstrategica','objetivoEstrategico','actividadReservada',
      'jefeUnidadGestora','gestorActividad','facultadDestinataria','departamentoDestinatario','centroUnidadUBDestinataria',
      'modalidadGestion','estadoActividad','asignaturaId','disciplinaRelacionadaId','idiomaImparticionId','tiposCertificacionId',
      'materiaDisciplinaId','ambitoFormacionId','tiposFinanciacionId','denominacionDescuentoIds','insc_modalidad','remesa','tiposInscripcionId'
    ],
    dynamicPatterns: [
      'subactividad_*_modalidad','subactividad_*_idioma','participante_*_rol'
    ]
  };

  window.UGFields = {
    IDP: ['coordinadorCentreUnitat','centreTreballeAlumne','ambitoFormacionId'],
    CRAI: ['asignaturaId','grupoAsignatura','disciplinaRelacionadaId','creditosTotalesCRAI'],
    SAE: ['creditosTotalesSAE','creditosMinimosSAE','creditosMaximosSAE','tipusEstudiSAE','categoriaSAE','competenciesSAE']
  };

  (function(){
    // Rellenar personaSolicitante con el usuario de sesi√≥n
    try {
      const userRaw = sessionStorage.getItem('ub_user');
      if (userRaw) {
        try { const user = JSON.parse(userRaw); const el = document.getElementById('personaSolicitante'); if (el) el.value = (user?.username || user?.name || ''); } catch {}
      }
    } catch {}

    const map = [
      { elementId: 'tipoActividad', dominio: 'TIPOS_ACTIVIDAD' },
      { elementId: 'unidadGestoraDetalle', dominio: 'SUBUNIDAD_GESTORA' },
      { elementId: 'lineaEstrategica', dominio: 'LINEAS_ESTRATEGICAS' },
      { elementId: 'objetivoEstrategico', dominio: 'OBJETIVOS_ESTRATEGICOS' },
      { elementId: 'actividadReservada', dominio: 'ACTIVIDADES_RESERVADAS' },
      { elementId: 'jefeUnidadGestora', dominio: 'JEFES_UNIDAD_GESTORA' },
      { elementId: 'gestorActividad', dominio: 'GESTORES_ACTIVIDAD' },
      { elementId: 'facultadDestinataria', dominio: 'FACULTADES_DESTINATARIAS' },
      { elementId: 'departamentoDestinatario', dominio: 'DEPARTAMENTOS_DESTINATARIOS' },
      { elementId: 'centroUnidadUBDestinataria', dominio: 'CENTROS_UB' },
      { elementId: 'modalidadGestion', dominio: 'MODALIDADES_GESTION' },
      { elementId: 'estadoActividad', dominio: 'EstadoActividad' },
      { elementId: 'coordinadorCentreUnitat', dominio: 'COORDINADORES_CENTRE_UNITAT_IDP' },
      { elementId: 'asignaturaId', dominio: 'Asignatura' },
      { elementId: 'disciplinaRelacionadaId', dominio: 'DisciplinaRelacionada' },
      { elementId: 'idiomaImparticionId', dominio: 'IdiomaImparticion' },
      { elementId: 'tiposCertificacionId', dominio: 'TiposCertificacion' },
      { elementId: 'materiaDisciplinaId', dominio: 'MateriaDisciplina' },
      { elementId: 'ambitoFormacionId', dominio: 'AmbitoFormacion' },
      { elementId: 'tiposFinanciacionId', dominio: 'TiposFinanciacion' },
      { elementId: 'denominacionDescuentoIds', dominio: 'DenominacionDescuento' },
      { elementId: 'insc_modalidad', dominio: 'MODALIDAD_IMPARTICION' },
      { elementId: 'remesa', dominio: 'Remesa' },
      { elementId: 'tiposInscripcionId', dominio: 'TiposInscripcion' },
      { elementId: 'tipusEstudiSAE', dominio: 'TIPUS_ESTUDI_SAE' },
      { elementId: 'categoriaSAE', dominio: 'CATEGORIAS_SAE' },
      { elementId: 'competenciesSAE', dominio: 'COMPETENCIAS_SAE' },
      { elementId: 'subactividad_1_modalidad', dominio: 'MODALIDAD_IMPARTICION' },
      { elementId: 'subactividad_1_idioma', dominio: 'IdiomaImparticion' },
      { elementId: 'participante_1_rol', dominio: 'TIPOS_PARTICIPANTE_ROL' },
    ];

    function setOptions(select, valores){
      if (!select) return;
      const keepFirst = select.firstElementChild && select.firstElementChild.value === '';
      while (select.options.length > (keepFirst?1:0)) select.remove(keepFirst?1:0);
      (valores||[]).forEach(v => {
        const opt = document.createElement('option');
        opt.value = (v.id ?? v.Id ?? '').toString();
        opt.textContent = v.descripcion ?? v.Descripcion ?? v.nombre ?? v.Nombre ?? String(v.id ?? v.Id ?? '');
        select.appendChild(opt);
      });
    }

    function getDominioDesdeCache(nombre){
      try {
        const raw = localStorage.getItem(`dominio_cache_${nombre}`);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    async function cargarDominiosAlta(){
      // UG principal: est√°tico para evitar backend (usar IDs 1/2/3)
      try {
        const ug = document.getElementById('actividadUnidadGestion');
        if (ug && ug.options.length <= 1) {
          const ugMap = { IDP: 1, CRAI: 2, SAE: 3 };
          Object.entries(ugMap).forEach(([label, id]) => {
            const o = document.createElement('option');
            o.value = String(id);
            o.textContent = label;
            ug.appendChild(o);
          });
        }
      } catch {}

      const presentes = map.filter(m => document.getElementById(m.elementId));
      presentes.forEach(m => {
        const valores = getDominioDesdeCache(m.dominio);
        setOptions(document.getElementById(m.elementId), valores);
      });
    }

    document.addEventListener('DOMContentLoaded', function(){
      try { cargarDominiosAlta(); } catch(e) { console.error(e); }
    });
  })();
</script>

<script>
function mostrarTraduccion(elemento) {
  const root = elemento.closest('.position-relative');
  if (!root) return;
  const panel = root.querySelector('.traduccion');
  if (!panel) return;
  // Detectar idioma actual (Weglot o lang del documento)
  let current = 'es';
  try {
    if (window.Weglot && typeof Weglot.getCurrentLang === 'function') {
      current = Weglot.getCurrentLang();
    } else {
      const htmlLang = (document.documentElement.getAttribute('lang') || '').toLowerCase();
      if (htmlLang) current = htmlLang.substring(0,2);
    }
  } catch {}
  // Mostrar solo los otros idiomas
  const rows = panel.querySelectorAll('.i18n-row');
  rows.forEach(r => {
    const lang = r.getAttribute('data-lang');
    if (lang === current) {
      r.classList.add('d-none');
    } else {
      r.classList.remove('d-none');
    }
  });
  panel.classList.toggle('d-none');
}
</script>

<!-- Helper de traducci√≥n eliminado (volveremos a a√±adirlo campo a campo cuando lo indiques) -->

<!-- Autenticaci√≥n m√≠nima (para cabecera) -->
<script src="auth.js?v=2.0"></script>

<script>
// Guardado b√°sico (solo secci√≥n Informaci√≥n general)
(function(){
  function escapeHtml(str){
    try {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
      return String(str).replace(/[&<>"']/g, ch => map[ch]);
    } catch { return String(str); }
  }
  function showPageError(title, details){
    try {
      const cont = document.getElementById('alertContainer');
      if (!cont) return;
      const pre = details ? `<pre class="mt-2 mb-0 small">${escapeHtml(details)}</pre>` : '';
      cont.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>${escapeHtml(title)}</strong>${pre}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
    } catch {}
  }
  function toIso(value){ return value ? new Date(value).toISOString() : null; }
  function getVal(id){ const el=document.getElementById(id); return el? el.value?.trim():''; }
  function getInt(id){ const v=getVal(id); const n=parseInt(v,10); return isNaN(n)? null : n; }
  function getReservadaInt(id){
    const v=(getVal(id)||'').toLowerCase();
    if (!v) return null;
    return (v==='1'||v==='true'||v==='s'||v==='si'||v==='s√≠') ? 1 : 0;
  }
  async function guardarActividadAlta(){
    try {
      // Validaci√≥n m√≠nima
      const titulo = getVal('actividadTitulo');
      const ug = getInt('actividadUnidadGestion');
      if (!titulo){ alert('El T√≠tulo es obligatorio'); return; }
      if (!ug){ alert('La Unidad Gestora es obligatoria'); return; }

      const payload = {
        Titulo: titulo,
        Codigo: getVal('actividadCodigo')||null,
        AnioAcademico: getVal('actividadAnioAcademico')||null,
        Descripcion: getVal('descripcion')||null,
        UnidadGestionId: ug,
        EstadoActividad: getVal('estadoActividad')||null,
        TipoActividad: getVal('tipoActividad')||null,
        LineaEstrategica: getVal('lineaEstrategica')||null,
        ObjetivoEstrategico: getVal('objetivoEstrategico')||null,
        CodigoRelacionado: getVal('codigoRelacionado')||null,
        ActividadReservada: getReservadaInt('actividadReservada'),
        FechaActividad: toIso(getVal('fechaActividad')),
        MotivoCierre: getVal('motivoCierre')||null,
        PersonaSolicitante: getVal('personaSolicitante')||null,
        JefeUnidadGestora: getVal('jefeUnidadGestora')||null,
        GestorActividad: getVal('gestorActividad')||null,
        FacultadDestinataria: getVal('facultadDestinataria')||null,
        DepartamentoDestinatario: getVal('departamentoDestinatario')||null,
        CentroUnidadUBDestinataria: getVal('centroUnidadUBDestinataria')||null,
        OtrosCentrosInstituciones: getVal('otrosCentrosInstituciones')||null,
        PlazasTotales: getInt('plazasTotales'),
        HorasTotales: (function(){ const v=getVal('horasTotales'); const n=parseFloat(v); return isNaN(n)? null:n; })(),
        ModalidadGestion: getVal('modalidadGestion')||null,
        FechaInicioImparticion: toIso(getVal('fechaInicioImparticion')),
        FechaFinImparticion: toIso(getVal('fechaFinImparticion')),
        // UG detalle
        UnidadGestoraDetalle: getVal('unidadGestoraDetalle')||null,
        CoordinadorCentreUnitat: getVal('coordinadorCentreUnitat')||null,
        CentreTreballeAlumne: getVal('centreTreballeAlumne')||null
      };

      // Limpiar null/undefined/''
      const cleaned={}; Object.entries(payload).forEach(([k,v])=>{ if(v!==null && v!==undefined && v!==''){ cleaned[k]=v; } });

      const token = sessionStorage.getItem('ub_token') || localStorage.getItem('ub_token') || '';
      const headers = new Headers({ 'Content-Type':'application/json' });
      if (token) headers.set('Authorization', `Bearer ${token}`);
      const res = await fetch('/api/actividades', { method: 'POST', headers, body: JSON.stringify(cleaned) });
      if (!res.ok){
        let bodyText = '';
        let bodyJson = null;
        try { bodyText = await res.text(); } catch {}
        try {
          if (bodyText && (bodyText.trim().startsWith('{') || (res.headers.get('content-type')||'').includes('application/json'))){
            bodyJson = JSON.parse(bodyText);
          }
        } catch {}
        try {
          console.groupCollapsed(`‚ùå Guardado fallido /api/actividades ‚Üí HTTP ${res.status} ${res.statusText}`);
          console.log('Payload enviado:', cleaned);
          console.log('Response headers:', Object.fromEntries(res.headers.entries()));
          if (bodyJson) { console.log('Response JSON:', bodyJson); } else { console.log('Response body:', bodyText); }
          console.groupEnd();
        } catch {}
        try { showPageError(`Error guardando (HTTP ${res.status} ${res.statusText})`, bodyJson? JSON.stringify(bodyJson, null, 2) : (bodyText||'(sin cuerpo)')); } catch {}
        throw new Error(`HTTP ${res.status} ${res.statusText}`);
      }
      const data = await res.json();
      alert('Actividad creada correctamente');
      try { window.location.href = `editar-actividad.html?id=${data.id||data.Id}`; } catch {}
    } catch(err){ console.error(err); alert('Error guardando actividad: '+err.message); }
  }
  document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('btnGuardarActividad');
    if (btn) btn.addEventListener('click', guardarActividadAlta);
  });
})();
</script>

</body>
</html>


