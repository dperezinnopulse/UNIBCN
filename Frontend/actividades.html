<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Actividades - UB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script defer src="scripts.js"></script>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-primary text-white p-3">
            <div class="col">
                <h1><i class="bi bi-calendar-event"></i> Gestión de Actividades UB</h1>
                <p class="mb-0">Sistema de gestión de actividades formativas</p>
            </div>
            <div class="col-auto d-flex align-items-center">
                <button class="btn btn-light" onclick="window.location.href='index.html'">
                    <i class="bi bi-plus-circle"></i> Nueva Actividad
                </button>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="row mt-4">
            <div class="col-12">
                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-funnel"></i> Filtros</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="filtroEstado">
                                    <option value="">Todos los estados</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Unidad de Gestión</label>
                                <select class="form-select" id="filtroUnidad">
                                    <option value="">Todas las unidades</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Buscar</label>
                                <input type="text" class="form-control" id="filtroBuscar" placeholder="Título o descripción...">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary me-2" onclick="cargarActividades()">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                                <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                                    <i class="bi bi-arrow-clockwise"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de actividades -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-list-ul"></i> Actividades</h5>
                        <div>
                            <span class="badge bg-secondary" id="contadorActividades">0 actividades</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Título</th>
                                        <th>Estado</th>
                                        <th>Unidad</th>
                                        <th>Fechas</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaActividades">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="bi bi-hourglass-split"></i> Cargando actividades...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginación -->
                        <nav aria-label="Navegación de páginas">
                            <ul class="pagination justify-content-center" id="paginacion">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación -->
    <div class="modal fade" id="modalConfirmacion" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="mensajeConfirmacion"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmar">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let actividadesActuales = [];
        let paginaActual = 1;
        let actividadesPorPagina = 10;

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            cargarFiltros();
            cargarActividades();
        });

        // Cargar filtros
        async function cargarFiltros() {
            try {
                // Cargar estados
                const estados = await api.getEstados();
                const filtroEstado = document.getElementById('filtroEstado');
                estados.forEach(estado => {
                    const option = document.createElement('option');
                    option.value = estado.id;
                    option.textContent = estado.nombre;
                    filtroEstado.appendChild(option);
                });

                // Cargar unidades de gestión
                const unidades = await api.getUnidadesGestion();
                const filtroUnidad = document.getElementById('filtroUnidad');
                unidades.forEach(unidad => {
                    const option = document.createElement('option');
                    option.value = unidad.id;
                    option.textContent = unidad.nombre;
                    filtroUnidad.appendChild(option);
                });
            } catch (error) {
                showMessage(`Error cargando filtros: ${error.message}`, 'danger');
            }
        }

        // Cargar actividades
        async function cargarActividades() {
            try {
                const filtros = {
                    estadoId: document.getElementById('filtroEstado').value,
                    unidadGestionId: document.getElementById('filtroUnidad').value,
                    busqueda: document.getElementById('filtroBuscar').value
                };

                const resultado = await api.getActividades(paginaActual, actividadesPorPagina, filtros);
                actividadesActuales = resultado.items || resultado;
                
                mostrarActividades();
                mostrarPaginacion(resultado.totalPages || 1);
                actualizarContador(resultado.totalItems || actividadesActuales.length);
            } catch (error) {
                showMessage(`Error cargando actividades: ${error.message}`, 'danger');
                mostrarActividades([]);
            }
        }

        // Mostrar actividades en la tabla
        function mostrarActividades() {
            const tbody = document.getElementById('tablaActividades');
            
            if (!actividadesActuales || actividadesActuales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="bi bi-inbox"></i> No se encontraron actividades
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = actividadesActuales.map(actividad => `
                <tr>
                    <td><span class="badge bg-secondary">${actividad.id}</span></td>
                    <td>
                        <strong>${actividad.titulo || 'Sin título'}</strong>
                        ${actividad.descripcion ? `<br><small class="text-muted">${actividad.descripcion.substring(0, 100)}...</small>` : ''}
                    </td>
                    <td>
                        <span class="badge ${getEstadoBadgeClass(actividad.estadoId || actividad.estado?.id)}">
                            ${actividad.estado?.nombre || 'Sin estado'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-info">
                            ${actividad.unidadGestion?.nombre || 'Sin unidad'}
                        </span>
                    </td>
                    <td>
                        <small>
                            ${actividad.fechaInicio ? `Inicio: ${new Date(actividad.fechaInicio).toLocaleDateString()}` : 'Sin fecha'}<br>
                            ${actividad.fechaFin ? `Fin: ${new Date(actividad.fechaFin).toLocaleDateString()}` : ''}
                        </small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editarActividad(${actividad.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="verActividad(${actividad.id})" title="Ver">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="confirmarEliminar(${actividad.id})" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Obtener clase CSS para el badge del estado
        function getEstadoBadgeClass(estadoId) {
            switch(estadoId) {
                case 1: return 'bg-secondary'; // Borrador
                case 2: return 'bg-warning';   // En Revisión
                case 3: return 'bg-success';   // Aprobado
                case 4: return 'bg-danger';    // Rechazado
                case 5: return 'bg-dark';      // Cancelado
                default: return 'bg-secondary';
            }
        }

        // Mostrar paginación
        function mostrarPaginacion(totalPaginas) {
            const paginacion = document.getElementById('paginacion');
            
            if (totalPaginas <= 1) {
                paginacion.innerHTML = '';
                return;
            }

            let html = '';
            
            // Botón anterior
            html += `
                <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPagina(${paginaActual - 1})">Anterior</a>
                </li>
            `;

            // Páginas
            for (let i = 1; i <= totalPaginas; i++) {
                html += `
                    <li class="page-item ${i === paginaActual ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="cambiarPagina(${i})">${i}</a>
                    </li>
                `;
            }

            // Botón siguiente
            html += `
                <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPagina(${paginaActual + 1})">Siguiente</a>
                </li>
            `;

            paginacion.innerHTML = html;
        }

        // Cambiar página
        function cambiarPagina(pagina) {
            if (pagina < 1) return;
            paginaActual = pagina;
            cargarActividades();
        }

        // Actualizar contador
        function actualizarContador(total) {
            document.getElementById('contadorActividades').textContent = `${total} actividades`;
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroUnidad').value = '';
            document.getElementById('filtroBuscar').value = '';
            paginaActual = 1;
            cargarActividades();
        }

        // Editar actividad
        function editarActividad(id) {
            window.location.href = `index.html?id=${id}`;
        }

        // Ver actividad
        function verActividad(id) {
            window.open(`index.html?id=${id}&modo=ver`, '_blank');
        }

        // Confirmar eliminación
        function confirmarEliminar(id) {
            const actividad = actividadesActuales.find(a => a.id === id);
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
            
            document.getElementById('mensajeConfirmacion').textContent = 
                `¿Estás seguro de que quieres eliminar la actividad "${actividad.titulo}"? Esta acción no se puede deshacer.`;
            
            document.getElementById('btnConfirmar').onclick = () => {
                eliminarActividad(id);
                modal.hide();
            };
            
            modal.show();
        }

        // Eliminar actividad
        async function eliminarActividad(id) {
            try {
                // Nota: El endpoint de eliminación no está implementado en el backend
                // Por ahora solo simulamos la eliminación
                showMessage('Funcionalidad de eliminación no implementada en el backend', 'warning');
                
                // Recargar actividades
                cargarActividades();
            } catch (error) {
                showMessage(`Error eliminando actividad: ${error.message}`, 'danger');
            }
        }

        // Event listeners para filtros
        document.getElementById('filtroBuscar').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                paginaActual = 1;
                cargarActividades();
            }
        });

        document.getElementById('filtroEstado').addEventListener('change', function() {
            paginaActual = 1;
            cargarActividades();
        });

        document.getElementById('filtroUnidad').addEventListener('change', function() {
            paginaActual = 1;
            cargarActividades();
        });
    </script>
</body>
</html>
