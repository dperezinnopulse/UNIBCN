<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test Diagn√≥stico - Dominios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Test Diagn√≥stico - Dominios</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Elementos a cargar:</h3>
                <div class="mb-3">
                    <label class="form-label">Tipo de Actividad</label>
                    <select class="form-select" id="tipoActividad">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">L√≠nea Estrat√©gica</label>
                    <select class="form-select" id="lineaEstrategica">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Actividad Reservada</label>
                    <select class="form-select" id="actividadReservada">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Centro/Unidad UB</label>
                    <select class="form-select" id="centroUnidadUBDestinataria">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Modalidad de Gesti√≥n</label>
                    <select class="form-select" id="modalidadGestion">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tipo de Impuesto</label>
                    <select class="form-select" id="imp_tipo">
                        <option value="">Cargando...</option>
                    </select>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>Debug Info</h3>
                <div id="debugInfo" class="alert alert-info">
                    <strong>Estado:</strong> Inicializando...
                </div>
                <button class="btn btn-primary" onclick="cargarDominios()">Cargar Dominios Manualmente</button>
                <button class="btn btn-secondary" onclick="limpiarLogs()">Limpiar Logs</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5001';
        
        function log(message, type = 'info') {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `<br><small>[${timestamp}]</small> ${message}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function limpiarLogs() {
            document.getElementById('debugInfo').innerHTML = '<strong>Estado:</strong> Logs limpiados';
        }
        
        // Obtener valores de un dominio espec√≠fico
        async function getValoresDominio(nombreDominio) {
            log(`üöÄ Obteniendo valores para dominio: ${nombreDominio}`, 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/api/dominios/${nombreDominio}/valores`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                log(`‚úÖ Respuesta para ${nombreDominio}: ${data.length} elementos`, 'success');
                return data;
            } catch (error) {
                log(`‚ùå Error obteniendo ${nombreDominio}: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Cargar valores de dominio en un elemento select
        async function loadValoresDominio(elementId, nombreDominio) {
            try {
                const element = document.getElementById(elementId);
                if (!element) {
                    log(`‚ö†Ô∏è Elemento no encontrado: ${elementId}`, 'warning');
                    return;
                }
                
                log(`üîç Cargando ${nombreDominio} en elemento: ${elementId}`, 'info');
                
                const valores = await getValoresDominio(nombreDominio);
                log(`üìä Valores obtenidos para ${nombreDominio}: ${valores.length}`, 'info');
                
                // Limpiar select
                element.innerHTML = '<option value="">Seleccionar...</option>';
                
                // Agregar opciones
                valores.forEach(valor => {
                    const option = document.createElement('option');
                    option.value = valor.valor;
                    option.textContent = valor.valor;
                    element.appendChild(option);
                });
                
                log(`‚úÖ Select ${elementId} llenado con ${valores.length} opciones`, 'success');
                
            } catch (error) {
                log(`‚ùå Error cargando ${nombreDominio}: ${error.message}`, 'error');
            }
        }
        
        // Cargar todos los dominios
        async function cargarDominios() {
            log('üöÄ Iniciando carga de dominios...', 'info');
            
            const dominiosACargar = [
                { elementId: 'tipoActividad', dominio: 'TIPOS_ACTIVIDAD' },
                { elementId: 'lineaEstrategica', dominio: 'LINEAS_ESTRATEGICAS' },
                { elementId: 'actividadReservada', dominio: 'ACTIVIDADES_RESERVADAS' },
                { elementId: 'modalidadGestion', dominio: 'MODALIDADES_GESTION' },
                { elementId: 'centroUnidadUBDestinataria', dominio: 'CENTROS_UB' },
                { elementId: 'imp_tipo', dominio: 'TIPOS_IMPUESTO' }
            ];

            let elementosEncontrados = 0;
            let elementosCargados = 0;

            for (const dominio of dominiosACargar) {
                const selectElement = document.getElementById(dominio.elementId);
                if (selectElement) {
                    elementosEncontrados++;
                    log(`üîç Cargando ${dominio.dominio} en ${dominio.elementId}`, 'info');
                    try {
                        await loadValoresDominio(dominio.elementId, dominio.dominio);
                        elementosCargados++;
                    } catch (error) {
                        log(`‚ùå Error cargando dominio ${dominio.dominio}: ${error}`, 'error');
                    }
                } else {
                    log(`‚ö†Ô∏è Elemento no encontrado: ${dominio.elementId}`, 'warning');
                }
            }
            
            log(`‚úÖ Carga completada. Encontrados: ${elementosEncontrados}, Cargados: ${elementosCargados}`, 'success');
        }
        
        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ DOM cargado, iniciando carga autom√°tica...', 'info');
            setTimeout(() => {
                cargarDominios();
            }, 1000);
        });
    </script>
</body>
</html>
