<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - UB Actividades</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script defer src="scripts.js"></script>
    <style>
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-primary text-white p-3">
            <div class="col">
                <h1><i class="bi bi-speedometer2"></i> Dashboard - UB Actividades</h1>
                <p class="mb-0">Panel de control y estadísticas del sistema</p>
            </div>
            <div class="col-auto d-flex align-items-center gap-2">
                <a href="actividades.html" class="btn btn-light">
                    <i class="bi bi-list-ul"></i> Actividades
                </a>
                <a href="index.html" class="btn btn-light">
                    <i class="bi bi-plus-circle"></i> Nueva Actividad
                </a>
            </div>
        </div>

        <!-- Estadísticas principales -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="display-4 text-primary mb-2">
                            <i class="bi bi-calendar-event"></i>
                        </div>
                        <h3 class="text-primary" id="totalActividades">-</h3>
                        <p class="text-muted mb-0">Total Actividades</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="display-4 text-success mb-2">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <h3 class="text-success" id="actividadesAprobadas">-</h3>
                        <p class="text-muted mb-0">Aprobadas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="display-4 text-warning mb-2">
                            <i class="bi bi-clock"></i>
                        </div>
                        <h3 class="text-warning" id="actividadesPendientes">-</h3>
                        <p class="text-muted mb-0">En Revisión</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="display-4 text-info mb-2">
                            <i class="bi bi-building"></i>
                        </div>
                        <h3 class="text-info" id="totalUnidades">-</h3>
                        <p class="text-muted mb-0">Unidades Activas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos y detalles -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5><i class="bi bi-pie-chart"></i> Distribución por Estado</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="estadosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5><i class="bi bi-bar-chart"></i> Actividades por Unidad</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="unidadesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actividades recientes -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-clock-history"></i> Actividades Recientes</h5>
                        <a href="actividades.html" class="btn btn-outline-primary btn-sm">Ver Todas</a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Título</th>
                                        <th>Estado</th>
                                        <th>Unidad</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="actividadesRecientes">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="bi bi-hourglass-split"></i> Cargando actividades recientes...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="row mt-4 mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5><i class="bi bi-lightning"></i> Acciones Rápidas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <a href="index.html" class="btn btn-primary w-100 p-3">
                                    <i class="bi bi-plus-circle display-6"></i>
                                    <br>Nueva Actividad
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="actividades.html" class="btn btn-outline-primary w-100 p-3">
                                    <i class="bi bi-list-ul display-6"></i>
                                    <br>Gestionar Actividades
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="test-api-demo.html" class="btn btn-outline-info w-100 p-3">
                                    <i class="bi bi-gear display-6"></i>
                                    <br>Probar API
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="https://localhost:7001/swagger" target="_blank" class="btn btn-outline-success w-100 p-3">
                                    <i class="bi bi-file-text display-6"></i>
                                    <br>Documentación API
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let estadisticas = {
            totalActividades: 0,
            actividadesAprobadas: 0,
            actividadesPendientes: 0,
            totalUnidades: 0,
            estados: [],
            unidades: []
        };

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            cargarEstadisticas();
            cargarActividadesRecientes();
        });

        // Cargar estadísticas
        async function cargarEstadisticas() {
            try {
                // Cargar actividades
                const actividades = await api.getActividades(1, 100);
                const items = actividades.items || actividades;
                
                // Cargar estados y unidades
                const estados = await api.getEstados();
                const unidades = await api.getUnidadesGestion();
                
                // Calcular estadísticas
                estadisticas.totalActividades = items.length;
                estadisticas.actividadesAprobadas = items.filter(a => a.estadoId === 3 || a.estado?.id === 3).length;
                estadisticas.actividadesPendientes = items.filter(a => a.estadoId === 2 || a.estado?.id === 2).length;
                estadisticas.totalUnidades = unidades.length;
                
                // Contar por estado
                estadisticas.estados = estados.map(estado => ({
                    nombre: estado.nombre,
                    cantidad: items.filter(a => a.estadoId === estado.id || a.estado?.id === estado.id).length
                }));
                
                // Contar por unidad
                estadisticas.unidades = unidades.map(unidad => ({
                    nombre: unidad.nombre,
                    cantidad: items.filter(a => a.unidadGestionId === unidad.id || a.unidadGestion?.id === unidad.id).length
                }));
                
                // Actualizar UI
                actualizarEstadisticas();
                crearGraficos();
                
            } catch (error) {
                showMessage(`Error cargando estadísticas: ${error.message}`, 'danger');
                // Usar datos de demo si hay error
                usarDatosDemo();
            }
        }

        // Actualizar estadísticas en la UI
        function actualizarEstadisticas() {
            document.getElementById('totalActividades').textContent = estadisticas.totalActividades;
            document.getElementById('actividadesAprobadas').textContent = estadisticas.actividadesAprobadas;
            document.getElementById('actividadesPendientes').textContent = estadisticas.actividadesPendientes;
            document.getElementById('totalUnidades').textContent = estadisticas.totalUnidades;
        }

        // Crear gráficos
        function crearGraficos() {
            // Gráfico de estados
            const ctxEstados = document.getElementById('estadosChart').getContext('2d');
            new Chart(ctxEstados, {
                type: 'doughnut',
                data: {
                    labels: estadisticas.estados.map(e => e.nombre),
                    datasets: [{
                        data: estadisticas.estados.map(e => e.cantidad),
                        backgroundColor: [
                            '#6c757d', // Borrador
                            '#ffc107', // En Revisión
                            '#198754', // Aprobado
                            '#dc3545', // Rechazado
                            '#212529'  // Cancelado
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Gráfico de unidades
            const ctxUnidades = document.getElementById('unidadesChart').getContext('2d');
            new Chart(ctxUnidades, {
                type: 'bar',
                data: {
                    labels: estadisticas.unidades.map(u => u.nombre.split(' - ')[0]), // Solo el código
                    datasets: [{
                        label: 'Actividades',
                        data: estadisticas.unidades.map(u => u.cantidad),
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Cargar actividades recientes
        async function cargarActividadesRecientes() {
            try {
                const actividades = await api.getActividades(1, 5);
                const items = actividades.items || actividades;
                
                mostrarActividadesRecientes(items);
            } catch (error) {
                showMessage(`Error cargando actividades recientes: ${error.message}`, 'danger');
            }
        }

        // Mostrar actividades recientes
        function mostrarActividadesRecientes(actividades) {
            const tbody = document.getElementById('actividadesRecientes');
            
            if (!actividades || actividades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="bi bi-inbox"></i> No hay actividades recientes
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = actividades.map(actividad => `
                <tr>
                    <td><span class="badge bg-secondary">${actividad.id}</span></td>
                    <td>
                        <strong>${actividad.titulo || 'Sin título'}</strong>
                        ${actividad.descripcion ? `<br><small class="text-muted">${actividad.descripcion.substring(0, 50)}...</small>` : ''}
                    </td>
                    <td>
                        <span class="badge ${getEstadoBadgeClass(actividad.estadoId || actividad.estado?.id)}">
                            ${actividad.estado?.nombre || 'Sin estado'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-info">
                            ${actividad.unidadGestion?.nombre || 'Sin unidad'}
                        </span>
                    </td>
                    <td>
                        <small>
                            ${actividad.fechaInicio ? new Date(actividad.fechaInicio).toLocaleDateString() : 'Sin fecha'}
                        </small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editarActividad(${actividad.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="verActividad(${actividad.id})" title="Ver">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Obtener clase CSS para el badge del estado
        function getEstadoBadgeClass(estadoId) {
            switch(estadoId) {
                case 1: return 'bg-secondary'; // Borrador
                case 2: return 'bg-warning';   // En Revisión
                case 3: return 'bg-success';   // Aprobado
                case 4: return 'bg-danger';    // Rechazado
                case 5: return 'bg-dark';      // Cancelado
                default: return 'bg-secondary';
            }
        }

        // Usar datos de demo si hay error
        function usarDatosDemo() {
            estadisticas = {
                totalActividades: 2,
                actividadesAprobadas: 1,
                actividadesPendientes: 1,
                totalUnidades: 3,
                estados: [
                    { nombre: "Borrador", cantidad: 0 },
                    { nombre: "En Revisión", cantidad: 1 },
                    { nombre: "Aprobado", cantidad: 1 },
                    { nombre: "Rechazado", cantidad: 0 },
                    { nombre: "Cancelado", cantidad: 0 }
                ],
                unidades: [
                    { nombre: "IDP", cantidad: 1 },
                    { nombre: "CRAI", cantidad: 1 },
                    { nombre: "SAE", cantidad: 0 }
                ]
            };
            
            actualizarEstadisticas();
            crearGraficos();
        }

        // Funciones de navegación
        function editarActividad(id) {
            window.location.href = `index.html?id=${id}`;
        }

        function verActividad(id) {
            window.open(`index.html?id=${id}&modo=ver`, '_blank');
        }
    </script>
</body>
</html>
