<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Test Dominios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
    <div class="container mt-5">
        <h1>Test de Dominios</h1>
        
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Tipo de Actividad</label>
                <select class="form-select" id="tipoActividad">
                    <option value="">Cargando...</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">L√≠nea Estrat√©gica</label>
                <select class="form-select" id="lineaEstrategica">
                    <option value="">Cargando...</option>
                </select>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label">Actividad Reservada</label>
                <select class="form-select" id="actividadReservada">
                    <option value="">Cargando...</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Modalidad de Gesti√≥n</label>
                <select class="form-select" id="modalidadGestion">
                    <option value="">Cargando...</option>
                </select>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label">Centro/Unidad UB</label>
                <select class="form-select" id="centroUnidadUBDestinataria">
                    <option value="">Cargando...</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Tipo de Impuesto</label>
                <select class="form-select" id="imp_tipo">
                    <option value="">Cargando...</option>
                </select>
            </div>
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="cargarDominios()">Cargar Dominios</button>
            <button class="btn btn-secondary" onclick="limpiarSelectores()">Limpiar</button>
        </div>
        
        <div class="mt-4">
            <h3>Logs:</h3>
            <div id="logs" class="bg-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        async function makeRequest(url, method = 'GET', data = null) {
            try {
                log(`üöÄ Haciendo request: ${method} ${url}`);
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                log(`‚úÖ Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                log(`üìä Datos recibidos: ${JSON.stringify(result).substring(0, 100)}...`);
                return result;
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                throw error;
            }
        }

        async function getValoresDominio(nombreDominio) {
            log(`üöÄ Obteniendo valores para dominio: ${nombreDominio}`);
            const url = `http://localhost:5001/api/dominios/${nombreDominio}/valores`;
            const valores = await makeRequest(url);
            log(`‚úÖ Valores obtenidos para ${nombreDominio}: ${valores.length} elementos`);
            return valores;
        }

        async function loadValoresDominio(nombreDominio, elementId) {
            try {
                const elemento = document.getElementById(elementId);
                if (!elemento) {
                    log(`‚ö†Ô∏è Elemento no encontrado: ${elementId}`);
                    return;
                }
                
                log(`üîç Cargando ${nombreDominio} en elemento: ${elementId}`);
                const valores = await getValoresDominio(nombreDominio);
                
                // Limpiar opciones existentes
                elemento.innerHTML = '<option value="">Seleccionar...</option>';
                
                // Agregar nuevas opciones
                valores.forEach(valor => {
                    const option = document.createElement('option');
                    option.value = valor.valor;
                    option.textContent = valor.valor;
                    elemento.appendChild(option);
                });
                
                log(`‚úÖ ${valores.length} opciones agregadas para ${nombreDominio}`);
            } catch (error) {
                log(`‚ùå Error cargando ${nombreDominio}: ${error.message}`);
            }
        }

        async function cargarDominios() {
            log('üöÄ Iniciando carga de dominios...');
            
            const dominiosACargar = [
                { nombre: 'TIPOS_ACTIVIDAD', elementId: 'tipoActividad' },
                { nombre: 'LINEAS_ESTRATEGICAS', elementId: 'lineaEstrategica' },
                { nombre: 'ACTIVIDADES_RESERVADAS', elementId: 'actividadReservada' },
                { nombre: 'MODALIDADES_GESTION', elementId: 'modalidadGestion' },
                { nombre: 'CENTROS_UB', elementId: 'centroUnidadUBDestinataria' },
                { nombre: 'TIPOS_IMPUESTO', elementId: 'imp_tipo' }
            ];
            
            for (const dominio of dominiosACargar) {
                await loadValoresDominio(dominio.nombre, dominio.elementId);
            }
            
            log('‚úÖ Carga de dominios completada');
        }

        function limpiarSelectores() {
            const selectores = ['tipoActividad', 'lineaEstrategica', 'actividadReservada', 'modalidadGestion', 'centroUnidadUBDestinataria', 'imp_tipo'];
            selectores.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.innerHTML = '<option value="">Seleccionar...</option>';
                }
            });
            log('üßπ Selectores limpiados');
        }

        // Cargar dominios autom√°ticamente al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina cargada, iniciando carga autom√°tica de dominios...');
            cargarDominios();
        });
    </script>
</body>
</html>
